// A version of the MOJ's add-another component what plays nice with the accessible autocomplete component.
// I did consider subclassing the MOJ's add-another component,
// but it would have been so coupled that it would've probably broken on an update of the MOJ library.
// So instead we forked it and made our own version.
window.FamilyHubsFrontend = window.FamilyHubsFrontend || {};
export function initializeAddAnother() {
    //todo: support options with scope?
    var $addAnothers = document.querySelectorAll('[data-module="fh-add-another"]');
    $addAnothers.forEach(function ($addAnother) {
        new window.FamilyHubsFrontend.AddAnother($addAnother);
    });
}
window.FamilyHubsFrontend.AddAnother = function (container) {
    this.container = $(container);
    if (this.container.data('fh-add-another-initialised')) {
        return;
    }
    this.container.data('fh-add-another-initialised', true);
    this.container.on('click', '.fh-add-another__remove-button', $.proxy(this, 'onRemoveButtonClick'));
    this.container.on('click', '.fh-add-another__add-button', $.proxy(this, 'onAddButtonClick'));
    this.container.find('.fh-add-another__add-button, fh-add-another__remove-button').prop('type', 'button');
};
window.FamilyHubsFrontend.AddAnother.prototype.onAddButtonClick = function (e) {
    var item = this.getNewItem();
    this.updateAttributes(this.getItems().length, item);
    this.resetItem(item);
    var firstItem = this.getItems().first();
    if (!this.hasRemoveButton(firstItem)) {
        this.createRemoveButton(firstItem);
    }
    this.getItems().last().after(item);
    item.find('input, textarea, select').first().focus();
};
window.FamilyHubsFrontend.AddAnother.prototype.hasRemoveButton = function (item) {
    return item.find('.fh-add-another__remove-button').length;
};
window.FamilyHubsFrontend.AddAnother.prototype.getItems = function () {
    return this.container.find('.fh-add-another__item');
};
window.FamilyHubsFrontend.AddAnother.prototype.getNewItem = function () {
    // Get the first item and clone it
    const items = this.getItems();
    const item = items[0].cloneNode(true);
    // Find the autocomplete wrappers and remove their parent
    const autocompleteWrappers = item.querySelectorAll('.autocomplete__wrapper');
    autocompleteWrappers.forEach(wrapper => {
        //    if (wrapper.parentNode) {
        //        wrapper.parentNode.removeChild(wrapper);
        //    }
        if (wrapper.parentNode.parentNode) {
            wrapper.parentNode.parentNode.removeChild(wrapper.parentNode);
        }
    });
    // Enhance the select elements
    const languageSelects = item.querySelectorAll("[id^='language-']");
    languageSelects.forEach(select => {
        accessibleAutocomplete.enhanceSelectElement({
            name: 'languageName',
            defaultValue: '',
            selectElement: select
        });
    });
    var $item = $(item);
    // Create a remove button if it doesn't exist
    if (!this.hasRemoveButton($item)) {
        this.createRemoveButton($item);
    }
    return $item;
};
/*
//window.FamilyHubsFrontend.AddAnother.prototype.getNewItem = function () {
//	//todo: before cloning, try finding the div with class autocomplete__wrapper, then removing it's parent
//	// then clone, then call the select enhance on the new select
//	// will need a way to pass a function in to do this//

//	var item = this.getItems().first().clone();
//	if (!this.hasRemoveButton(item)) {
//		this.createRemoveButton(item);
//	}
    //	return item;

    var item = this.getItems().first().clone();

    //const autocompleteWrappers = item.find('.autocomplete__wrapper');
    //var autocompleteWrappers = document.querySelectorAll('.autocomplete__wrapper');

 //       //if (autocompleteWrappers.length) {
 //           autocompleteWrappers.forEach(function(wrapper) {
 //               wrapper.parentNode.remove();
 //           });
 //       //}
 //       //}

    const autocompleteWrappers = item.find('.autocomplete__wrapper');
    if (autocompleteWrappers.length) {
        autocompleteWrappers.each(function () {
            $(this).parent().remove();
        });
    }

    //todo: just poc!
    const languageSelects = item[0].querySelectorAll("[id^='language-']") as NodeListOf<HTMLSelectElement>; // [id$='\\d+']");

    languageSelects.forEach(function (select) {
        accessibleAutocomplete.enhanceSelectElement({
            //defaultValue: select.value,
            //todo: does it default to name in html?
            //name: select.name,
            name: 'languageName',
            defaultValue: '',
            selectElement: select
        })
    });


    if (!this.hasRemoveButton(item)) {
        this.createRemoveButton(item);
    }
    return item;
};
*/
window.FamilyHubsFrontend.AddAnother.prototype.updateAttributes = function (index, item) {
    item.find('[data-name]').each(function (i, el) {
        var originalId = el.id;
        el.name = $(el).attr('data-name').replace(/%index%/, index);
        el.id = $(el).attr('data-id').replace(/%index%/, index);
        var label = $(el).siblings('label')[0] || $(el).parents('label')[0] || item.find('[for="' + originalId + '"]')[0];
        label.htmlFor = el.id;
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.createRemoveButton = function (item) {
    item.append('<button type="button" class="govuk-button govuk-button--secondary fh-add-another__remove-button">Remove</button>');
};
window.FamilyHubsFrontend.AddAnother.prototype.resetItem = function (item) {
    // accessibile-autocomplete adds an input (without data-name or data-id)
    // so we blank all input controls
    item.find('input, textarea, select').each(function (index, el) {
        if (el.type == 'checkbox' || el.type == 'radio') {
            el.checked = false;
        }
        else {
            el.value = '';
        }
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.onRemoveButtonClick = function (e) {
    $(e.currentTarget).parents('.fh-add-another__item').remove();
    var items = this.getItems();
    if (items.length === 1) {
        items.find('.fh-add-another__remove-button').remove();
    }
    items.each($.proxy(function (index, el) {
        this.updateAttributes(index, $(el));
    }, this));
    this.focusHeading();
};
window.FamilyHubsFrontend.AddAnother.prototype.focusHeading = function () {
    this.container.find('.fh-add-another__heading').focus();
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWRkLWFub3RoZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsMkdBQTJHO0FBQzNHLDhEQUE4RDtBQUM5RCxzR0FBc0c7QUFDdEcsb0RBQW9EO0FBaUJwRCxNQUFNLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxDQUFDLGtCQUFrQixJQUFJLEVBQUUsQ0FBQztBQUU1RCxNQUFNLFVBQVUsb0JBQW9CO0lBQ2hDLG1DQUFtQztJQUNuQyxJQUFJLFlBQVksR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztJQUUvRSxZQUFZLENBQUMsT0FBTyxDQUFDLFVBQVUsV0FBVztRQUM1QyxJQUFJLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDcEQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsR0FBRyxVQUFVLFNBQVM7SUFDekQsSUFBSSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7SUFFOUIsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxFQUFFLENBQUM7UUFDdkQsT0FBTTtJQUNQLENBQUM7SUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUV4RCxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxDQUFDO0lBQ25HLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7SUFDN0YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJ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SSxDQUFDLENBQUMsQ0FBQztJQUNWLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUNyQixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUc7SUFDN0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUN6RCxDQUFDLENBQUMiLCJmaWxlIjoiY29tcG9uZW50cy9hZGQtYW5vdGhlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEEgdmVyc2lvbiBvZiB0aGUgTU9KJ3MgYWRkLWFub3RoZXIgY29tcG9uZW50IHdoYXQgcGxheXMgbmljZSB3aXRoIHRoZSBhY2Nlc3NpYmxlIGF1dG9jb21wbGV0ZSBjb21wb25lbnQuXHJcbi8vIEkgZGlkIGNvbnNpZGVyIHN1YmNsYXNzaW5nIHRoZSBNT0oncyBhZGQtYW5vdGhlciBjb21wb25lbnQsXHJcbi8vIGJ1dCBpdCB3b3VsZCBoYXZlIGJlZW4gc28gY291cGxlZCB0aGF0IGl0IHdvdWxkJ3ZlIHByb2JhYmx5IGJyb2tlbiBvbiBhbiB1cGRhdGUgb2YgdGhlIE1PSiBsaWJyYXJ5LlxyXG4vLyBTbyBpbnN0ZWFkIHdlIGZvcmtlZCBpdCBhbmQgbWFkZSBvdXIgb3duIHZlcnNpb24uXHJcblxyXG4vL3RvZG86IHRoZSBjcmVhdGVkIGFjY2Vzc2libGUgIGlucHV0IHdoZW4gYWRkaW5nIGRvZXNuJ3QgaGF2ZSB0aGUgaWQvbmFtZSBkYXRhIGF0dHJzLCBzbyB3ZSBnZXQgZHVwZSBpZHNcclxuLy90b2RvOiB0aGVyZSBzZWVtcyB0byBiZSBhIGJ1ZyBpbiBhY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZSB3aGVyZSB0aGUgaW5wdXQgaXQgY3JlYXRlcyBoYXMgdGhlIHNhbWUgaWQgYXMgdGhlIHNlbGVjdFxyXG4vL3RvZG86IHdlIG5lZWQgdG8gaW5pdGlhbGlzZSB0aGUgYWNjZXNzaWJsZSBhdXRvY29tcGxldGUgb24gdGhlIG5ldyBpdGVtXHJcbi8vdG9kbzogd2hlbiBlbmhhbmNpbmcgdGhlIHNlbGVjdCBpbiBhY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZSwgaXQgcmV0dXJucyB0aGUgbmFtZSByYXRoZXIgdGhhbiB0aGUgdmFsdWVcclxuLy8gdGhlcmUncyBhIHdvcmthcm91bmQuLi5cclxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2FscGhhZ292L2FjY2Vzc2libGUtYXV0b2NvbXBsZXRlL2lzc3Vlcy8zODdcclxuLy8gYnV0IHdlIGNvdWxkIHdlIHJvbGwgaXQgaW50byBvdXIgYWRkLWFub3RoZXIgY29tcG9uZW50P1xyXG4vL3RvZG86IHdoZW4gYWNjZXNzaWJsZS1hdXRvY29tcGxldGUgY3JlYXRlcyB0aGUgaW5wdXQsIGl0IGRvZXNuJ3QgaGFuZGxlIHRoZSBhcmlhLWRlc2NyaWJlZGJ5IGNvcnJlY3RseS4uLlxyXG4vLyBodHRwczovL2dpdGh1Yi5jb20vYWxwaGFnb3YvYWNjZXNzaWJsZS1hdXRvY29tcGxldGUvaXNzdWVzLzU4OVxyXG5cclxuLy90b2RvOiB1c2UgdGhlIGluZGV4LmQudHMgZnJvbSBoZXJlLi4uXHJcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbHBoYWdvdi9hY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZS9pc3N1ZXMvNTM1XHJcbmRlY2xhcmUgY29uc3QgYWNjZXNzaWJsZUF1dG9jb21wbGV0ZTogYW55O1xyXG5cclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQgPSB3aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kIHx8IHt9O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluaXRpYWxpemVBZGRBbm90aGVyKCk6IHZvaWQge1xyXG4gICAgLy90b2RvOiBzdXBwb3J0IG9wdGlvbnMgd2l0aCBzY29wZT9cclxuICAgIHZhciAkYWRkQW5vdGhlcnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1tb2R1bGU9XCJmaC1hZGQtYW5vdGhlclwiXScpO1xyXG5cclxuICAgICRhZGRBbm90aGVycy5mb3JFYWNoKGZ1bmN0aW9uICgkYWRkQW5vdGhlcikge1xyXG5cdFx0bmV3IHdpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlcigkYWRkQW5vdGhlcik7XHJcbiAgICB9KTtcclxufVxyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyID0gZnVuY3Rpb24gKGNvbnRhaW5lcikge1xyXG5cdHRoaXMuY29udGFpbmVyID0gJChjb250YWluZXIpO1xyXG5cclxuXHRpZiAodGhpcy5jb250YWluZXIuZGF0YSgnZmgtYWRkLWFub3RoZXItaW5pdGlhbGlzZWQnKSkge1xyXG5cdFx0cmV0dXJuXHJcblx0fVxyXG5cclxuXHR0aGlzLmNvbnRhaW5lci5kYXRhKCdmaC1hZGQtYW5vdGhlci1pbml0aWFsaXNlZCcsIHRydWUpO1xyXG5cclxuXHR0aGlzLmNvbnRhaW5lci5vbignY2xpY2snLCAnLmZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJywgJC5wcm94eSh0aGlzLCAnb25SZW1vdmVCdXR0b25DbGljaycpKTtcclxuXHR0aGlzLmNvbnRhaW5lci5vbignY2xpY2snLCAnLmZoLWFkZC1hbm90aGVyX19hZGQtYnV0dG9uJywgJC5wcm94eSh0aGlzLCAnb25BZGRCdXR0b25DbGljaycpKTtcclxuXHR0aGlzLmNvbnRhaW5lci5maW5kKCcuZmgtYWRkLWFub3RoZXJfX2FkZC1idXR0b24sIGZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJykucHJvcCgndHlwZScsICdidXR0b24nKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUub25BZGRCdXR0b25DbGljayA9IGZ1bmN0aW9uIChlKSB7XHJcblx0dmFyIGl0ZW0gPSB0aGlzLmdldE5ld0l0ZW0oKTtcclxuXHR0aGlzLnVwZGF0ZUF0dHJpYnV0ZXModGhpcy5nZXRJdGVtcygpLmxlbmd0aCwgaXRlbSk7XHJcblx0dGhpcy5yZXNldEl0ZW0oaXRlbSk7XHJcblx0dmFyIGZpcnN0SXRlbSA9IHRoaXMuZ2V0SXRlbXMoKS5maXJzdCgpO1xyXG5cdGlmICghdGhpcy5oYXNSZW1vdmVCdXR0b24oZmlyc3RJdGVtKSkge1xyXG5cdFx0dGhpcy5jcmVhdGVSZW1vdmVCdXR0b24oZmlyc3RJdGVtKTtcclxuXHR9XHJcblx0dGhpcy5nZXRJdGVtcygpLmxhc3QoKS5hZnRlcihpdGVtKTtcclxuXHRpdGVtLmZpbmQoJ2lucHV0LCB0ZXh0YXJlYSwgc2VsZWN0JykuZmlyc3QoKS5mb2N1cygpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5oYXNSZW1vdmVCdXR0b24gPSBmdW5jdGlvbiAoaXRlbSkge1xyXG5cdHJldHVybiBpdGVtLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9fcmVtb3ZlLWJ1dHRvbicpLmxlbmd0aDtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuZ2V0SXRlbXMgPSBmdW5jdGlvbiAoKSB7XHJcblx0cmV0dXJuIHRoaXMuY29udGFpbmVyLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9faXRlbScpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5nZXROZXdJdGVtID0gZnVuY3Rpb24gKCkgeyAvLzogSlF1ZXJ5PEhUTUxFbGVtZW50PiAvL0hUTUxFbGVtZW50IHtcclxuICAgIC8vIEdldCB0aGUgZmlyc3QgaXRlbSBhbmQgY2xvbmUgaXRcclxuICAgIGNvbnN0IGl0ZW1zID0gdGhpcy5nZXRJdGVtcygpO1xyXG4gICAgY29uc3QgaXRlbSA9IGl0ZW1zWzBdLmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MRWxlbWVudDtcclxuXHJcbiAgICAvLyBGaW5kIHRoZSBhdXRvY29tcGxldGUgd3JhcHBlcnMgYW5kIHJlbW92ZSB0aGVpciBwYXJlbnRcclxuICAgIGNvbnN0IGF1dG9jb21wbGV0ZVdyYXBwZXJzID0gaXRlbS5xdWVyeVNlbGVjdG9yQWxsKCcuYXV0b2NvbXBsZXRlX193cmFwcGVyJyk7XHJcbiAgICBhdXRvY29tcGxldGVXcmFwcGVycy5mb3JFYWNoKHdyYXBwZXIgPT4ge1xyXG4gICAgLy8gICAgaWYgKHdyYXBwZXIucGFyZW50Tm9kZSkge1xyXG4gICAgLy8gICAgICAgIHdyYXBwZXIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh3cmFwcGVyKTtcclxuICAgICAgICAvLyAgICB9XHJcbiAgICAgICAgaWYgKHdyYXBwZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlKSB7XHJcblx0XHRcdHdyYXBwZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHdyYXBwZXIucGFyZW50Tm9kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gRW5oYW5jZSB0aGUgc2VsZWN0IGVsZW1lbnRzXHJcbiAgICBjb25zdCBsYW5ndWFnZVNlbGVjdHMgPSBpdGVtLnF1ZXJ5U2VsZWN0b3JBbGwoXCJbaWRePSdsYW5ndWFnZS0nXVwiKSBhcyBOb2RlTGlzdE9mPEhUTUxTZWxlY3RFbGVtZW50PjtcclxuICAgIGxhbmd1YWdlU2VsZWN0cy5mb3JFYWNoKHNlbGVjdCA9PiB7XHJcbiAgICAgICAgYWNjZXNzaWJsZUF1dG9jb21wbGV0ZS5lbmhhbmNlU2VsZWN0RWxlbWVudCh7XHJcbiAgICAgICAgICAgIG5hbWU6ICdsYW5ndWFnZU5hbWUnLFxyXG4gICAgICAgICAgICBkZWZhdWx0VmFsdWU6ICcnLFxyXG4gICAgICAgICAgICBzZWxlY3RFbGVtZW50OiBzZWxlY3RcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIHZhciAkaXRlbSA9ICQoaXRlbSk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIGEgcmVtb3ZlIGJ1dHRvbiBpZiBpdCBkb2Vzbid0IGV4aXN0XHJcbiAgICBpZiAoIXRoaXMuaGFzUmVtb3ZlQnV0dG9uKCRpdGVtKSkge1xyXG4gICAgICAgIHRoaXMuY3JlYXRlUmVtb3ZlQnV0dG9uKCRpdGVtKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gJGl0ZW07XHJcbn07XHJcblxyXG4vKlxyXG4vL3dpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuZ2V0TmV3SXRlbSA9IGZ1bmN0aW9uICgpIHtcclxuLy9cdC8vdG9kbzogYmVmb3JlIGNsb25pbmcsIHRyeSBmaW5kaW5nIHRoZSBkaXYgd2l0aCBjbGFzcyBhdXRvY29tcGxldGVfX3dyYXBwZXIsIHRoZW4gcmVtb3ZpbmcgaXQncyBwYXJlbnRcclxuLy9cdC8vIHRoZW4gY2xvbmUsIHRoZW4gY2FsbCB0aGUgc2VsZWN0IGVuaGFuY2Ugb24gdGhlIG5ldyBzZWxlY3RcclxuLy9cdC8vIHdpbGwgbmVlZCBhIHdheSB0byBwYXNzIGEgZnVuY3Rpb24gaW4gdG8gZG8gdGhpcy8vXHJcblxyXG4vL1x0dmFyIGl0ZW0gPSB0aGlzLmdldEl0ZW1zKCkuZmlyc3QoKS5jbG9uZSgpO1xyXG4vL1x0aWYgKCF0aGlzLmhhc1JlbW92ZUJ1dHRvbihpdGVtKSkge1xyXG4vL1x0XHR0aGlzLmNyZWF0ZVJlbW92ZUJ1dHRvbihpdGVtKTtcclxuLy9cdH1cclxuXHQvL1x0cmV0dXJuIGl0ZW07XHJcblxyXG5cdHZhciBpdGVtID0gdGhpcy5nZXRJdGVtcygpLmZpcnN0KCkuY2xvbmUoKTtcclxuXHJcblx0Ly9jb25zdCBhdXRvY29tcGxldGVXcmFwcGVycyA9IGl0ZW0uZmluZCgnLmF1dG9jb21wbGV0ZV9fd3JhcHBlcicpO1xyXG5cdC8vdmFyIGF1dG9jb21wbGV0ZVdyYXBwZXJzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmF1dG9jb21wbGV0ZV9fd3JhcHBlcicpO1xyXG5cclxuIC8vICAgICAgIC8vaWYgKGF1dG9jb21wbGV0ZVdyYXBwZXJzLmxlbmd0aCkge1xyXG4gLy8gICAgICAgICAgIGF1dG9jb21wbGV0ZVdyYXBwZXJzLmZvckVhY2goZnVuY3Rpb24od3JhcHBlcikge1xyXG4gLy8gICAgICAgICAgICAgICB3cmFwcGVyLnBhcmVudE5vZGUucmVtb3ZlKCk7XHJcbiAvLyAgICAgICAgICAgfSk7XHJcbiAvLyAgICAgICAvL31cclxuIC8vICAgICAgIC8vfVxyXG5cclxuXHRjb25zdCBhdXRvY29tcGxldGVXcmFwcGVycyA9IGl0ZW0uZmluZCgnLmF1dG9jb21wbGV0ZV9fd3JhcHBlcicpO1xyXG5cdGlmIChhdXRvY29tcGxldGVXcmFwcGVycy5sZW5ndGgpIHtcclxuXHRcdGF1dG9jb21wbGV0ZVdyYXBwZXJzLmVhY2goZnVuY3Rpb24gKCkge1xyXG5cdFx0XHQkKHRoaXMpLnBhcmVudCgpLnJlbW92ZSgpO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHQvL3RvZG86IGp1c3QgcG9jIVxyXG5cdGNvbnN0IGxhbmd1YWdlU2VsZWN0cyA9IGl0ZW1bMF0ucXVlcnlTZWxlY3RvckFsbChcIltpZF49J2xhbmd1YWdlLSddXCIpIGFzIE5vZGVMaXN0T2Y8SFRNTFNlbGVjdEVsZW1lbnQ+OyAvLyBbaWQkPSdcXFxcZCsnXVwiKTtcclxuXHJcbiBcdGxhbmd1YWdlU2VsZWN0cy5mb3JFYWNoKGZ1bmN0aW9uIChzZWxlY3QpIHtcclxuXHRcdGFjY2Vzc2libGVBdXRvY29tcGxldGUuZW5oYW5jZVNlbGVjdEVsZW1lbnQoe1xyXG5cdFx0XHQvL2RlZmF1bHRWYWx1ZTogc2VsZWN0LnZhbHVlLFxyXG5cdFx0XHQvL3RvZG86IGRvZXMgaXQgZGVmYXVsdCB0byBuYW1lIGluIGh0bWw/XHJcblx0XHRcdC8vbmFtZTogc2VsZWN0Lm5hbWUsXHJcblx0XHRcdG5hbWU6ICdsYW5ndWFnZU5hbWUnLFxyXG5cdFx0XHRkZWZhdWx0VmFsdWU6ICcnLFxyXG5cdFx0XHRzZWxlY3RFbGVtZW50OiBzZWxlY3RcclxuXHRcdH0pXHJcblx0fSk7XHJcblxyXG5cclxuICAgIGlmICghdGhpcy5oYXNSZW1vdmVCdXR0b24oaXRlbSkpIHtcclxuICAgICAgICB0aGlzLmNyZWF0ZVJlbW92ZUJ1dHRvbihpdGVtKTtcclxuICAgIH1cclxuICAgIHJldHVybiBpdGVtO1xyXG59O1xyXG4qL1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS51cGRhdGVBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKGluZGV4LCBpdGVtKSB7XHJcblx0aXRlbS5maW5kKCdbZGF0YS1uYW1lXScpLmVhY2goZnVuY3Rpb24gKGksIGVsKSB7XHJcblx0XHR2YXIgb3JpZ2luYWxJZCA9IGVsLmlkXHJcblxyXG5cdFx0ZWwubmFtZSA9ICQoZWwpLmF0dHIoJ2RhdGEtbmFtZScpLnJlcGxhY2UoLyVpbmRleCUvLCBpbmRleCk7XHJcblx0XHRlbC5pZCA9ICQoZWwpLmF0dHIoJ2RhdGEtaWQnKS5yZXBsYWNlKC8laW5kZXglLywgaW5kZXgpO1xyXG5cclxuXHRcdHZhciBsYWJlbCA9ICQoZWwpLnNpYmxpbmdzKCdsYWJlbCcpWzBdIHx8ICQoZWwpLnBhcmVudHMoJ2xhYmVsJylbMF0gfHwgaXRlbS5maW5kKCdbZm9yPVwiJyArIG9yaWdpbmFsSWQgKyAnXCJdJylbMF07XHJcblx0XHRsYWJlbC5odG1sRm9yID0gZWwuaWQ7XHJcblx0fSk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmNyZWF0ZVJlbW92ZUJ1dHRvbiA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcblx0aXRlbS5hcHBlbmQoJzxidXR0b24gdHlwZT1cImJ1dHRvblwiIGNsYXNzPVwiZ292dWstYnV0dG9uIGdvdnVrLWJ1dHRvbi0tc2Vjb25kYXJ5IGZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uXCI+UmVtb3ZlPC9idXR0b24+Jyk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLnJlc2V0SXRlbSA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcblx0Ly8gYWNjZXNzaWJpbGUtYXV0b2NvbXBsZXRlIGFkZHMgYW4gaW5wdXQgKHdpdGhvdXQgZGF0YS1uYW1lIG9yIGRhdGEtaWQpXHJcblx0Ly8gc28gd2UgYmxhbmsgYWxsIGlucHV0IGNvbnRyb2xzXHJcbiAgICBpdGVtLmZpbmQoJ2lucHV0LCB0ZXh0YXJlYSwgc2VsZWN0JykuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsKSB7XHJcbiAgICAgICAgaWYgKGVsLnR5cGUgPT0gJ2NoZWNrYm94JyB8fCBlbC50eXBlID09ICdyYWRpbycpIHtcclxuICAgICAgICAgICAgZWwuY2hlY2tlZCA9IGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGVsLnZhbHVlID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLm9uUmVtb3ZlQnV0dG9uQ2xpY2sgPSBmdW5jdGlvbiAoZSkge1xyXG5cdCQoZS5jdXJyZW50VGFyZ2V0KS5wYXJlbnRzKCcuZmgtYWRkLWFub3RoZXJfX2l0ZW0nKS5yZW1vdmUoKTtcclxuXHR2YXIgaXRlbXMgPSB0aGlzLmdldEl0ZW1zKCk7XHJcblx0aWYgKGl0ZW1zLmxlbmd0aCA9PT0gMSkge1xyXG5cdFx0aXRlbXMuZmluZCgnLmZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJykucmVtb3ZlKCk7XHJcblx0fVxyXG5cdGl0ZW1zLmVhY2goJC5wcm94eShmdW5jdGlvbiAoaW5kZXgsIGVsKSB7XHJcblx0XHR0aGlzLnVwZGF0ZUF0dHJpYnV0ZXMoaW5kZXgsICQoZWwpKTtcclxuXHR9LCB0aGlzKSk7XHJcblx0dGhpcy5mb2N1c0hlYWRpbmcoKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuZm9jdXNIZWFkaW5nID0gZnVuY3Rpb24gKCkge1xyXG5cdHRoaXMuY29udGFpbmVyLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9faGVhZGluZycpLmZvY3VzKCk7XHJcbn07XHJcbiJdfQ==
