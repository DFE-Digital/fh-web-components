// A version of the MOJ's add-another component that plays nice with the accessible autocomplete component
// and works with errored fields.
// I did consider subclassing the MOJ's add-another component,
// but it would have been so coupled that it would've probably broken on an update of the MOJ library.
// So instead we forked it and made our own version.
//todo: when accessible-autocomplete creates the input, it doesn't handle the aria-describedby correctly...
// https://github.com/alphagov/accessible-autocomplete/issues/589
window.FamilyHubsFrontend = window.FamilyHubsFrontend || {};
export function initializeAddAnother() {
    //todo: support options with scope?
    var $addAnothers = document.querySelectorAll('[data-module="fh-add-another"]');
    $addAnothers.forEach(function ($addAnother) {
        new window.FamilyHubsFrontend.AddAnother($addAnother);
    });
}
window.FamilyHubsFrontend.AddAnother = function (container) {
    this.container = $(container);
    this.index = 0;
    if (this.container.data('fh-add-another-initialised')) {
        return;
    }
    //todo: this is a bit hacky - find a better way to do this
    var functionName = container.getAttribute('data-fh-add-another-callback');
    this.callback = null;
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window[functionName] === 'function') {
            this.callback = window[functionName];
            this.callback(container);
        }
    }.bind(this));
    this.container.data('fh-add-another-initialised', true);
    this.container.on('click', '.fh-add-another__remove-button', $.proxy(this, 'onRemoveButtonClick'));
    this.container.on('click', '.fh-add-another__add-button', $.proxy(this, 'onAddButtonClick'));
    this.container.find('.fh-add-another__add-button, fh-add-another__remove-button').prop('type', 'submit');
};
window.FamilyHubsFrontend.AddAnother.prototype.onAddButtonClick = function (e) {
    var item = this.getNewItem();
    var firstItem = this.getItems().first();
    if (!this.hasRemoveButton(firstItem)) {
        this.createRemoveButton(firstItem);
    }
    this.getItems().last().after(item);
    item.find('input, textarea, select').first().focus();
    e.preventDefault();
};
window.FamilyHubsFrontend.AddAnother.prototype.hasRemoveButton = function (item) {
    return item.find('.fh-add-another__remove-button').length;
};
window.FamilyHubsFrontend.AddAnother.prototype.getItems = function () {
    return this.container.find('.fh-add-another__item');
};
// todo: ? a better approach would be to have a template item that we clone,
// rather than having to strip the error from the first item
window.FamilyHubsFrontend.AddAnother.prototype.stripErrorFromNewItem = function (item) {
    // find all divs and remove the govuk-form-group--error class if it exists
    //item.querySelectorAll('div').forEach(function (el, index) {
    //       if (el.classList.contains('govuk-form-group--error')) {
    //           el.classList.remove('govuk-form-group--error');
    //       }
    //   });
    //item.find('.govuk-form-group--error').removeClass('govuk-form-group--error');
    item.querySelectorAll('div.govuk-form-group--error').forEach(function (el, index) {
        el.classList.remove('govuk-form-group--error');
    });
    // using vanilla js, find all paragraphs with the class govuk-error-message and remove them
    item.querySelectorAll('p.govuk-error-message').forEach(function (el, index) {
        el.parentNode.removeChild(el);
    });
    // using vanilla js, find all selects with the class govuk-select--error and remove it
    item.querySelectorAll('select.govuk-select--error').forEach(function (el, index) {
        el.classList.remove('govuk-select--error');
    });
    item.querySelectorAll('input.govuk-input--error').forEach(function (el, index) {
        el.classList.remove('govuk-input--error');
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.getNewItem = function () {
    // get the first item and clone it
    const items = this.getItems();
    const item = items[0].cloneNode(true);
    this.stripErrorFromNewItem(item);
    // find the autocomplete wrappers and remove the elements that are added by accessible-autocomplete
    const autocompleteWrappers = item.querySelectorAll('.autocomplete__wrapper');
    autocompleteWrappers.forEach(wrapper => {
        if (wrapper.parentNode.parentNode) {
            wrapper.parentNode.parentNode.removeChild(wrapper.parentNode);
        }
    });
    var $item = $(item);
    // update the id and name attributes
    this.updateAttributes(++this.index, $item);
    this.resetItem($item);
    // call the callback which needs to apply accessibility-autocomplete enhancements to the new item
    if (typeof this.callback === 'function') {
        this.callback(item);
    }
    // Create a remove button if it doesn't exist
    if (!this.hasRemoveButton($item)) {
        this.createRemoveButton($item);
    }
    return $item;
};
window.FamilyHubsFrontend.AddAnother.prototype.updateAttributes = function (index, item) {
    item.find('[data-name]').each(function (i, el) {
        var originalId = el.id;
        el.name = $(el).attr('data-name').replace(/%index%/, index);
        el.id = $(el).attr('data-id').replace(/%index%/, index);
        var label = $(el).siblings('label')[0] || $(el).parents('label')[0] || item.find('[for="' + originalId + '"]')[0];
        label.htmlFor = el.id;
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.createRemoveButton = function (item) {
    item.append('<button type="submit" class="govuk-button govuk-button--secondary fh-add-another__remove-button">Remove</button>');
};
window.FamilyHubsFrontend.AddAnother.prototype.resetItem = function (item) {
    // accessibile-autocomplete adds an input (without data-name or data-id)
    // so we blank all input controls
    item.find('input, textarea, select').each(function (index, el) {
        if (el.type == 'checkbox' || el.type == 'radio') {
            el.checked = false;
        }
        else {
            el.value = '';
        }
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.onRemoveButtonClick = function (e) {
    $(e.currentTarget).parents('.fh-add-another__item').remove();
    var items = this.getItems();
    if (items.length === 1) {
        items.find('.fh-add-another__remove-button').remove();
    }
    this.focusHeading();
    e.preventDefault();
};
window.FamilyHubsFrontend.AddAnother.prototype.focusHeading = function () {
    this.container.find('.fh-add-another__heading').focus();
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWRkLWFub3RoZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsMEdBQTBHO0FBQzFHLGlDQUFpQztBQUNqQyw4REFBOEQ7QUFDOUQsc0dBQXNHO0FBQ3RHLG9EQUFvRDtBQUVwRCwyR0FBMkc7QUFDM0csaUVBQWlFO0FBRWpFLE1BQU0sQ0FBQyxrQkFBa0IsR0FBRyxNQUFNLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBRTVELE1BQU0sVUFBVSxvQkFBb0I7SUFDaEMsbUNBQW1DO0lBQ25DLElBQUksWUFBWSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBRWxGLFlBQVksQ0FBQyxPQUFPLENBQUMsVUFBVSxXQUFXO1FBQ3pDLElBQUksTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxHQUFHLFVBQVUsU0FBUztJQUN6RCxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM5QixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztJQUVmLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsNEJBQTRCLENBQUMsRUFBRSxDQUFDO1FBQ3ZELE9BQU07SUFDUCxDQUFDO0lBRUQsMERBQTBEO0lBQzFELElBQUksWUFBWSxHQUFHLFNBQVMsQ0FBQyxZQUFZLENBQUMsOEJBQThCLENBQUMsQ0FBQztJQUUxRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztJQUNyQixRQUFRLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUU7UUFDN0MsSUFBSSxPQUFPLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUNoRCxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzFCLENBQUM7SUFDRixDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFFZCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUV4RCxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxDQUFDO0lBQ25HLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7SUFDN0YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsNERBQTRELENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQzFHLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLGdCQUFnQixHQUFHLFVBQVUsQ0FBQztJQUM1RSxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFFN0IsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7UUFDdEMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFDRCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25DLElBQUksQ0FBQyxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNyRCxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDcEIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsZUFBZSxHQUFHLFVBQVUsSUFBSTtJQUM5RSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsZ0NBQWdDLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDM0QsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsUUFBUSxHQUFHO0lBQ3pELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUNyRCxDQUFDLENBQUM7QUFFRiw0RUFBNEU7QUFDNUUsNERBQTREO0FBQzVELE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLHFCQUFxQixHQUFHLFVBQVUsSUFBaUI7SUFDakcsMEVBQTBFO0lBQzFFLDZEQUE2RDtJQUM3RCxnRUFBZ0U7SUFDaEUsNERBQTREO0lBQzVELFVBQVU7SUFDVixRQUFRO0lBQ1IsK0VBQStFO0lBQy9FLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsRUFBRSxLQUFLO1FBQy9FLEVBQUUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDaEQsQ0FBQyxDQUFDLENBQUM7SUFFSCwyRkFBMkY7SUFDM0YsSUFBSSxDQUFDLGdCQUFnQixDQUFDLHVCQUF1QixDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLEtBQUs7UUFDbkUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDckMsQ0FBQyxDQUFDLENBQUM7SUFFSCxzRkFBc0Y7SUFDdEYsSUFBSSxDQUFDLGdCQUFnQixDQUFDLDRCQUE0QixDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLEtBQUs7UUFDeEUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQztJQUNsRCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxnQkFBZ0IsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsRUFBRSxLQUFLO1FBQzVFLEVBQUUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDM0MsQ0FBQyxDQUFDLENBQUM7QUFDSixDQUFDLENBQUE7QUFFRCxNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxVQUFVLEdBQUc7SUFDeEQsa0NBQWtDO0lBQ2xDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM5QixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBZ0IsQ0FBQztJQUV4RCxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFOUIsbUdBQW1HO0lBQ25HLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLHdCQUF3QixDQUFDLENBQUM7SUFDN0Usb0JBQW9CLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ25DLElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUN6QyxPQUFPLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3pELENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVOLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVwQixvQ0FBb0M7SUFDcEMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUUzQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRXRCLGlHQUFpRztJQUNqRyxJQUFJLE9BQU8sSUFBSSxDQUFDLFFBQVEsS0FBSyxVQUFVLEVBQUUsQ0FBQztRQUN6QyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JCLENBQUM7SUFFRSw2Q0FBNkM7SUFDN0MsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2pCLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLGdCQUFnQixHQUFHLFVBQVUsS0FBSyxFQUFFLElBQUk7SUFDdEYsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsRUFBRTtRQUM1QyxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFBO1FBRXRCLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzVELEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXhELElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxVQUFVLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEgsS0FBSyxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQ3ZCLENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsa0JBQWtCLEdBQUcsVUFBVSxJQUFJO0lBQ2pGLElBQUksQ0FBQyxNQUFNLENBQUMsa0hBQWtILENBQUMsQ0FBQztBQUNqSSxDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsVUFBVSxJQUFJO0lBQ3hFLHdFQUF3RTtJQUN4RSxpQ0FBaUM7SUFDOUIsSUFBSSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEtBQUssRUFBRSxFQUFFO1FBQy9ELElBQUksRUFBRSxDQUFDLElBQUksSUFBSSxVQUFVLElBQUksRUFBRSxDQUFDLElBQUksSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUNqRCxFQUFFLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNwQixDQUFDO2FBQ0ksQ0FBQztZQUNJLEVBQUUsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLG1CQUFtQixHQUFHLFVBQVUsQ0FBQztJQUMvRSxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQzdELElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM1QixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDeEIsS0FBSyxDQUFDLElBQUksQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3ZELENBQUM7SUFDRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDcEIsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO0FBQ3BCLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLFlBQVksR0FBRztJQUM3RCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ3pELENBQUMsQ0FBQyIsImZpbGUiOiJjb21wb25lbnRzL2FkZC1hbm90aGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQSB2ZXJzaW9uIG9mIHRoZSBNT0oncyBhZGQtYW5vdGhlciBjb21wb25lbnQgdGhhdCBwbGF5cyBuaWNlIHdpdGggdGhlIGFjY2Vzc2libGUgYXV0b2NvbXBsZXRlIGNvbXBvbmVudFxyXG4vLyBhbmQgd29ya3Mgd2l0aCBlcnJvcmVkIGZpZWxkcy5cclxuLy8gSSBkaWQgY29uc2lkZXIgc3ViY2xhc3NpbmcgdGhlIE1PSidzIGFkZC1hbm90aGVyIGNvbXBvbmVudCxcclxuLy8gYnV0IGl0IHdvdWxkIGhhdmUgYmVlbiBzbyBjb3VwbGVkIHRoYXQgaXQgd291bGQndmUgcHJvYmFibHkgYnJva2VuIG9uIGFuIHVwZGF0ZSBvZiB0aGUgTU9KIGxpYnJhcnkuXHJcbi8vIFNvIGluc3RlYWQgd2UgZm9ya2VkIGl0IGFuZCBtYWRlIG91ciBvd24gdmVyc2lvbi5cclxuXHJcbi8vdG9kbzogd2hlbiBhY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZSBjcmVhdGVzIHRoZSBpbnB1dCwgaXQgZG9lc24ndCBoYW5kbGUgdGhlIGFyaWEtZGVzY3JpYmVkYnkgY29ycmVjdGx5Li4uXHJcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbHBoYWdvdi9hY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZS9pc3N1ZXMvNTg5XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kID0gd2luZG93LkZhbWlseUh1YnNGcm9udGVuZCB8fCB7fTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplQWRkQW5vdGhlcigpOiB2b2lkIHtcclxuICAgIC8vdG9kbzogc3VwcG9ydCBvcHRpb25zIHdpdGggc2NvcGU/XHJcbiAgICB2YXIgJGFkZEFub3RoZXJzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtbW9kdWxlPVwiZmgtYWRkLWFub3RoZXJcIl0nKTtcclxuXHJcblx0JGFkZEFub3RoZXJzLmZvckVhY2goZnVuY3Rpb24gKCRhZGRBbm90aGVyKSB7XHJcblx0XHRuZXcgd2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyKCRhZGRBbm90aGVyKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIgPSBmdW5jdGlvbiAoY29udGFpbmVyKSB7XHJcblx0dGhpcy5jb250YWluZXIgPSAkKGNvbnRhaW5lcik7XHJcblx0dGhpcy5pbmRleCA9IDA7XHJcblxyXG5cdGlmICh0aGlzLmNvbnRhaW5lci5kYXRhKCdmaC1hZGQtYW5vdGhlci1pbml0aWFsaXNlZCcpKSB7XHJcblx0XHRyZXR1cm5cclxuXHR9XHJcblxyXG5cdC8vdG9kbzogdGhpcyBpcyBhIGJpdCBoYWNreSAtIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIGRvIHRoaXNcclxuXHR2YXIgZnVuY3Rpb25OYW1lID0gY29udGFpbmVyLmdldEF0dHJpYnV0ZSgnZGF0YS1maC1hZGQtYW5vdGhlci1jYWxsYmFjaycpO1xyXG5cclxuXHR0aGlzLmNhbGxiYWNrID0gbnVsbDtcclxuXHRkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24gKCkge1xyXG5cdFx0aWYgKHR5cGVvZiB3aW5kb3dbZnVuY3Rpb25OYW1lXSA9PT0gJ2Z1bmN0aW9uJykge1xyXG5cdFx0XHR0aGlzLmNhbGxiYWNrID0gd2luZG93W2Z1bmN0aW9uTmFtZV07XHJcblx0XHRcdHRoaXMuY2FsbGJhY2soY29udGFpbmVyKTtcclxuXHRcdH1cclxuXHR9LmJpbmQodGhpcykpO1xyXG5cclxuXHR0aGlzLmNvbnRhaW5lci5kYXRhKCdmaC1hZGQtYW5vdGhlci1pbml0aWFsaXNlZCcsIHRydWUpO1xyXG5cclxuXHR0aGlzLmNvbnRhaW5lci5vbignY2xpY2snLCAnLmZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJywgJC5wcm94eSh0aGlzLCAnb25SZW1vdmVCdXR0b25DbGljaycpKTtcclxuXHR0aGlzLmNvbnRhaW5lci5vbignY2xpY2snLCAnLmZoLWFkZC1hbm90aGVyX19hZGQtYnV0dG9uJywgJC5wcm94eSh0aGlzLCAnb25BZGRCdXR0b25DbGljaycpKTtcclxuXHR0aGlzLmNvbnRhaW5lci5maW5kKCcuZmgtYWRkLWFub3RoZXJfX2FkZC1idXR0b24sIGZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJykucHJvcCgndHlwZScsICdzdWJtaXQnKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUub25BZGRCdXR0b25DbGljayA9IGZ1bmN0aW9uIChlKSB7XHJcblx0dmFyIGl0ZW0gPSB0aGlzLmdldE5ld0l0ZW0oKTtcclxuXHJcblx0dmFyIGZpcnN0SXRlbSA9IHRoaXMuZ2V0SXRlbXMoKS5maXJzdCgpO1xyXG5cdGlmICghdGhpcy5oYXNSZW1vdmVCdXR0b24oZmlyc3RJdGVtKSkge1xyXG5cdFx0dGhpcy5jcmVhdGVSZW1vdmVCdXR0b24oZmlyc3RJdGVtKTtcclxuXHR9XHJcblx0dGhpcy5nZXRJdGVtcygpLmxhc3QoKS5hZnRlcihpdGVtKTtcclxuXHRpdGVtLmZpbmQoJ2lucHV0LCB0ZXh0YXJlYSwgc2VsZWN0JykuZmlyc3QoKS5mb2N1cygpO1xyXG5cdGUucHJldmVudERlZmF1bHQoKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuaGFzUmVtb3ZlQnV0dG9uID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuXHRyZXR1cm4gaXRlbS5maW5kKCcuZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nKS5sZW5ndGg7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmdldEl0ZW1zID0gZnVuY3Rpb24gKCkge1xyXG5cdHJldHVybiB0aGlzLmNvbnRhaW5lci5maW5kKCcuZmgtYWRkLWFub3RoZXJfX2l0ZW0nKTtcclxufTtcclxuXHJcbi8vIHRvZG86ID8gYSBiZXR0ZXIgYXBwcm9hY2ggd291bGQgYmUgdG8gaGF2ZSBhIHRlbXBsYXRlIGl0ZW0gdGhhdCB3ZSBjbG9uZSxcclxuLy8gcmF0aGVyIHRoYW4gaGF2aW5nIHRvIHN0cmlwIHRoZSBlcnJvciBmcm9tIHRoZSBmaXJzdCBpdGVtXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuc3RyaXBFcnJvckZyb21OZXdJdGVtID0gZnVuY3Rpb24gKGl0ZW06IEhUTUxFbGVtZW50KSB7XHJcblx0Ly8gZmluZCBhbGwgZGl2cyBhbmQgcmVtb3ZlIHRoZSBnb3Z1ay1mb3JtLWdyb3VwLS1lcnJvciBjbGFzcyBpZiBpdCBleGlzdHNcclxuXHQvL2l0ZW0ucXVlcnlTZWxlY3RvckFsbCgnZGl2JykuZm9yRWFjaChmdW5jdGlvbiAoZWwsIGluZGV4KSB7XHJcbiAvLyAgICAgICBpZiAoZWwuY2xhc3NMaXN0LmNvbnRhaW5zKCdnb3Z1ay1mb3JtLWdyb3VwLS1lcnJvcicpKSB7XHJcbiAvLyAgICAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZSgnZ292dWstZm9ybS1ncm91cC0tZXJyb3InKTtcclxuIC8vICAgICAgIH1cclxuIC8vICAgfSk7XHJcblx0Ly9pdGVtLmZpbmQoJy5nb3Z1ay1mb3JtLWdyb3VwLS1lcnJvcicpLnJlbW92ZUNsYXNzKCdnb3Z1ay1mb3JtLWdyb3VwLS1lcnJvcicpO1xyXG5cdGl0ZW0ucXVlcnlTZWxlY3RvckFsbCgnZGl2LmdvdnVrLWZvcm0tZ3JvdXAtLWVycm9yJykuZm9yRWFjaChmdW5jdGlvbiAoZWwsIGluZGV4KSB7XHJcblx0XHRlbC5jbGFzc0xpc3QucmVtb3ZlKCdnb3Z1ay1mb3JtLWdyb3VwLS1lcnJvcicpO1xyXG5cdH0pO1xyXG5cclxuXHQvLyB1c2luZyB2YW5pbGxhIGpzLCBmaW5kIGFsbCBwYXJhZ3JhcGhzIHdpdGggdGhlIGNsYXNzIGdvdnVrLWVycm9yLW1lc3NhZ2UgYW5kIHJlbW92ZSB0aGVtXHJcblx0aXRlbS5xdWVyeVNlbGVjdG9yQWxsKCdwLmdvdnVrLWVycm9yLW1lc3NhZ2UnKS5mb3JFYWNoKGZ1bmN0aW9uIChlbCwgaW5kZXgpIHtcclxuICAgICAgICBlbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsKTtcclxuXHR9KTtcclxuXHJcblx0Ly8gdXNpbmcgdmFuaWxsYSBqcywgZmluZCBhbGwgc2VsZWN0cyB3aXRoIHRoZSBjbGFzcyBnb3Z1ay1zZWxlY3QtLWVycm9yIGFuZCByZW1vdmUgaXRcclxuXHRpdGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJ3NlbGVjdC5nb3Z1ay1zZWxlY3QtLWVycm9yJykuZm9yRWFjaChmdW5jdGlvbiAoZWwsIGluZGV4KSB7XHJcbiAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZSgnZ292dWstc2VsZWN0LS1lcnJvcicpO1xyXG5cdH0pO1xyXG5cclxuXHRpdGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0LmdvdnVrLWlucHV0LS1lcnJvcicpLmZvckVhY2goZnVuY3Rpb24gKGVsLCBpbmRleCkge1xyXG5cdFx0ZWwuY2xhc3NMaXN0LnJlbW92ZSgnZ292dWstaW5wdXQtLWVycm9yJyk7XHJcblx0fSk7XHJcbn1cclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuZ2V0TmV3SXRlbSA9IGZ1bmN0aW9uICgpIHsgLy86IEpRdWVyeTxIVE1MRWxlbWVudD4gLy9IVE1MRWxlbWVudCB7XHJcbiAgICAvLyBnZXQgdGhlIGZpcnN0IGl0ZW0gYW5kIGNsb25lIGl0XHJcbiAgICBjb25zdCBpdGVtcyA9IHRoaXMuZ2V0SXRlbXMoKTtcclxuICAgIGNvbnN0IGl0ZW0gPSBpdGVtc1swXS5jbG9uZU5vZGUodHJ1ZSkgYXMgSFRNTEVsZW1lbnQ7XHJcblxyXG5cdHRoaXMuc3RyaXBFcnJvckZyb21OZXdJdGVtKGl0ZW0pO1xyXG5cclxuICAgIC8vIGZpbmQgdGhlIGF1dG9jb21wbGV0ZSB3cmFwcGVycyBhbmQgcmVtb3ZlIHRoZSBlbGVtZW50cyB0aGF0IGFyZSBhZGRlZCBieSBhY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZVxyXG4gICAgY29uc3QgYXV0b2NvbXBsZXRlV3JhcHBlcnMgPSBpdGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJy5hdXRvY29tcGxldGVfX3dyYXBwZXInKTtcclxuICAgIGF1dG9jb21wbGV0ZVdyYXBwZXJzLmZvckVhY2god3JhcHBlciA9PiB7XHJcbiAgICAgICAgaWYgKHdyYXBwZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlKSB7XHJcblx0XHRcdHdyYXBwZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHdyYXBwZXIucGFyZW50Tm9kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG5cdHZhciAkaXRlbSA9ICQoaXRlbSk7XHJcblxyXG5cdC8vIHVwZGF0ZSB0aGUgaWQgYW5kIG5hbWUgYXR0cmlidXRlc1xyXG5cdHRoaXMudXBkYXRlQXR0cmlidXRlcygrK3RoaXMuaW5kZXgsICRpdGVtKTtcclxuXHJcblx0dGhpcy5yZXNldEl0ZW0oJGl0ZW0pO1xyXG5cclxuXHQvLyBjYWxsIHRoZSBjYWxsYmFjayB3aGljaCBuZWVkcyB0byBhcHBseSBhY2Nlc3NpYmlsaXR5LWF1dG9jb21wbGV0ZSBlbmhhbmNlbWVudHMgdG8gdGhlIG5ldyBpdGVtXHJcblx0aWYgKHR5cGVvZiB0aGlzLmNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XHJcblx0XHR0aGlzLmNhbGxiYWNrKGl0ZW0pO1xyXG5cdH1cclxuXHJcbiAgICAvLyBDcmVhdGUgYSByZW1vdmUgYnV0dG9uIGlmIGl0IGRvZXNuJ3QgZXhpc3RcclxuICAgIGlmICghdGhpcy5oYXNSZW1vdmVCdXR0b24oJGl0ZW0pKSB7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVSZW1vdmVCdXR0b24oJGl0ZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiAkaXRlbTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUudXBkYXRlQXR0cmlidXRlcyA9IGZ1bmN0aW9uIChpbmRleCwgaXRlbSkge1xyXG5cdGl0ZW0uZmluZCgnW2RhdGEtbmFtZV0nKS5lYWNoKGZ1bmN0aW9uIChpLCBlbCkge1xyXG5cdFx0dmFyIG9yaWdpbmFsSWQgPSBlbC5pZFxyXG5cclxuXHRcdGVsLm5hbWUgPSAkKGVsKS5hdHRyKCdkYXRhLW5hbWUnKS5yZXBsYWNlKC8laW5kZXglLywgaW5kZXgpO1xyXG5cdFx0ZWwuaWQgPSAkKGVsKS5hdHRyKCdkYXRhLWlkJykucmVwbGFjZSgvJWluZGV4JS8sIGluZGV4KTtcclxuXHJcblx0XHR2YXIgbGFiZWwgPSAkKGVsKS5zaWJsaW5ncygnbGFiZWwnKVswXSB8fCAkKGVsKS5wYXJlbnRzKCdsYWJlbCcpWzBdIHx8IGl0ZW0uZmluZCgnW2Zvcj1cIicgKyBvcmlnaW5hbElkICsgJ1wiXScpWzBdO1xyXG5cdFx0bGFiZWwuaHRtbEZvciA9IGVsLmlkO1xyXG5cdH0pO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5jcmVhdGVSZW1vdmVCdXR0b24gPSBmdW5jdGlvbiAoaXRlbSkge1xyXG5cdGl0ZW0uYXBwZW5kKCc8YnV0dG9uIHR5cGU9XCJzdWJtaXRcIiBjbGFzcz1cImdvdnVrLWJ1dHRvbiBnb3Z1ay1idXR0b24tLXNlY29uZGFyeSBmaC1hZGQtYW5vdGhlcl9fcmVtb3ZlLWJ1dHRvblwiPlJlbW92ZTwvYnV0dG9uPicpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5yZXNldEl0ZW0gPSBmdW5jdGlvbiAoaXRlbSkge1xyXG5cdC8vIGFjY2Vzc2liaWxlLWF1dG9jb21wbGV0ZSBhZGRzIGFuIGlucHV0ICh3aXRob3V0IGRhdGEtbmFtZSBvciBkYXRhLWlkKVxyXG5cdC8vIHNvIHdlIGJsYW5rIGFsbCBpbnB1dCBjb250cm9sc1xyXG4gICAgaXRlbS5maW5kKCdpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCcpLmVhY2goZnVuY3Rpb24gKGluZGV4LCBlbCkge1xyXG5cdFx0aWYgKGVsLnR5cGUgPT0gJ2NoZWNrYm94JyB8fCBlbC50eXBlID09ICdyYWRpbycpIHtcclxuXHRcdFx0ZWwuY2hlY2tlZCA9IGZhbHNlO1xyXG5cdFx0fVxyXG5cdFx0ZWxzZSB7XHJcbiAgICAgICAgICAgIGVsLnZhbHVlID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLm9uUmVtb3ZlQnV0dG9uQ2xpY2sgPSBmdW5jdGlvbiAoZSkge1xyXG5cdCQoZS5jdXJyZW50VGFyZ2V0KS5wYXJlbnRzKCcuZmgtYWRkLWFub3RoZXJfX2l0ZW0nKS5yZW1vdmUoKTtcclxuXHR2YXIgaXRlbXMgPSB0aGlzLmdldEl0ZW1zKCk7XHJcblx0aWYgKGl0ZW1zLmxlbmd0aCA9PT0gMSkge1xyXG5cdFx0aXRlbXMuZmluZCgnLmZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJykucmVtb3ZlKCk7XHJcblx0fVxyXG5cdHRoaXMuZm9jdXNIZWFkaW5nKCk7XHJcblx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5mb2N1c0hlYWRpbmcgPSBmdW5jdGlvbiAoKSB7XHJcblx0dGhpcy5jb250YWluZXIuZmluZCgnLmZoLWFkZC1hbm90aGVyX19oZWFkaW5nJykuZm9jdXMoKTtcclxufTtcclxuIl19
