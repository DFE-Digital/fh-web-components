// A version of the MOJ's add-another component that plays nice with the accessible autocomplete component.
// I did consider subclassing the MOJ's add-another component,
// but it would have been so coupled that it would've probably broken on an update of the MOJ library.
// So instead we forked it and made our own version.
window.FamilyHubsFrontend = window.FamilyHubsFrontend || {};
export function initializeAddAnother() {
    //todo: support options with scope?
    var $addAnothers = document.querySelectorAll('[data-module="fh-add-another"]');
    $addAnothers.forEach(function ($addAnother) {
        new window.FamilyHubsFrontend.AddAnother($addAnother);
    });
}
window.FamilyHubsFrontend.AddAnother = function (container) {
    this.container = $(container);
    this.index = 0;
    if (this.container.data('fh-add-another-initialised')) {
        return;
    }
    //todo: this is a bit hacky - find a better way to do this
    var functionName = container.getAttribute('data-fh-add-another-callback');
    this.callback = null;
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window[functionName] === 'function') {
            this.callback = window[functionName];
            this.callback(container);
        }
    }.bind(this));
    this.container.data('fh-add-another-initialised', true);
    this.container.on('click', '.fh-add-another__remove-button', $.proxy(this, 'onRemoveButtonClick'));
    this.container.on('click', '.fh-add-another__add-button', $.proxy(this, 'onAddButtonClick'));
    this.container.find('.fh-add-another__add-button, fh-add-another__remove-button').prop('type', 'button');
};
window.FamilyHubsFrontend.AddAnother.prototype.onAddButtonClick = function (e) {
    var item = this.getNewItem();
    //this.resetItem(item);
    var firstItem = this.getItems().first();
    if (!this.hasRemoveButton(firstItem)) {
        this.createRemoveButton(firstItem);
    }
    this.getItems().last().after(item);
    item.find('input, textarea, select').first().focus();
};
window.FamilyHubsFrontend.AddAnother.prototype.hasRemoveButton = function (item) {
    return item.find('.fh-add-another__remove-button').length;
};
window.FamilyHubsFrontend.AddAnother.prototype.getItems = function () {
    return this.container.find('.fh-add-another__item');
};
window.FamilyHubsFrontend.AddAnother.prototype.getNewItem = function () {
    // get the first item and clone it
    const items = this.getItems();
    const item = items[0].cloneNode(true);
    // find the autocomplete wrappers and remove the elements that are added by accessible-autocomplete
    const autocompleteWrappers = item.querySelectorAll('.autocomplete__wrapper');
    autocompleteWrappers.forEach(wrapper => {
        if (wrapper.parentNode.parentNode) {
            wrapper.parentNode.parentNode.removeChild(wrapper.parentNode);
        }
    });
    var $item = $(item);
    // update the id and name attributes
    this.updateAttributes(++this.index, $item);
    this.resetItem($item);
    // call the callback which needs to apply accessibility-autocomplete enhancements to the new item
    if (typeof this.callback === 'function') {
        this.callback(item);
    }
    // Create a remove button if it doesn't exist
    if (!this.hasRemoveButton($item)) {
        this.createRemoveButton($item);
    }
    return $item;
};
window.FamilyHubsFrontend.AddAnother.prototype.updateAttributes = function (index, item) {
    item.find('[data-name]').each(function (i, el) {
        var originalId = el.id;
        el.name = $(el).attr('data-name').replace(/%index%/, index);
        el.id = $(el).attr('data-id').replace(/%index%/, index);
        var label = $(el).siblings('label')[0] || $(el).parents('label')[0] || item.find('[for="' + originalId + '"]')[0];
        label.htmlFor = el.id;
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.createRemoveButton = function (item) {
    item.append('<button type="button" class="govuk-button govuk-button--secondary fh-add-another__remove-button">Remove</button>');
};
// select the option with the passed value, even if it's disabled
window.FamilyHubsFrontend.AddAnother.prototype.selectOption = function (el, value) {
    let option = el.querySelector(`option[value="${value}"]`);
    if (option) {
        let wasDisabled = option.disabled;
        option.disabled = false;
        el.value = value;
        option.disabled = wasDisabled;
    }
};
window.FamilyHubsFrontend.AddAnother.prototype.resetItem = function (item) {
    // accessibile-autocomplete adds an input (without data-name or data-id)
    // so we blank all input controls
    var This = this;
    item.find('input, textarea, select').each(function (index, el) {
        if (el.type == 'checkbox' || el.type == 'radio') {
            el.checked = false;
        }
        else if (el.tagName.toLowerCase() === 'select') {
            //todo: this should set the value to defaultValue as passed to enhanceSelectElement
            //This.selectOption(el, '');
            //$('select#genres option[selected]').removeAttr("selected");
            let oldOption = el.querySelector('option[selected]');
            oldOption.removeAttribute("selected");
            let option = el.querySelector('option[value=""]');
            if (option) {
                let wasDisabled = option.disabled;
                option.disabled = false;
                el.value = '';
                option.disabled = wasDisabled;
            }
        }
        else {
            el.value = '';
        }
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.onRemoveButtonClick = function (e) {
    $(e.currentTarget).parents('.fh-add-another__item').remove();
    var items = this.getItems();
    if (items.length === 1) {
        items.find('.fh-add-another__remove-button').remove();
    }
    this.focusHeading();
};
window.FamilyHubsFrontend.AddAnother.prototype.focusHeading = function () {
    this.container.find('.fh-add-another__heading').focus();
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWRkLWFub3RoZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsMkdBQTJHO0FBQzNHLDhEQUE4RDtBQUM5RCxzR0FBc0c7QUFDdEcsb0RBQW9EO0FBV3BELE1BQU0sQ0FBQyxrQkFBa0IsR0FBRyxNQUFNLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBRTVELE1BQU0sVUFBVSxvQkFBb0I7SUFDaEMsbUNBQW1DO0lBQ25DLElBQUksWUFBWSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBRWxGLFlBQVksQ0FBQyxPQUFPLENBQUMsVUFBVSxXQUFXO1FBQ3pDLElBQUksTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxHQUFHLFVBQVUsU0FBUztJQUN6RCxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM5QixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztJQUVmLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsNEJBQTRCLENBQUMsRUFBRSxDQUFDO1FBQ3ZELE9BQU07SUFDUCxDQUFDO0lBRUQsMERBQTBEO0lBQzFELElBQUksWUFBWSxHQUFHLFNBQVMsQ0FBQyxZQUFZLENBQUMsOEJBQThCLENBQUMsQ0FBQztJQUUxRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztJQUNyQixRQUFRLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUU7UUFDN0MsSUFBSSxPQUFPLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUNoRCxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsUUFBUSxD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LENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLFlBQVksR0FBRztJQUM3RCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ3pELENBQUMsQ0FBQyIsImZpbGUiOiJjb21wb25lbnRzL2FkZC1hbm90aGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQSB2ZXJzaW9uIG9mIHRoZSBNT0oncyBhZGQtYW5vdGhlciBjb21wb25lbnQgdGhhdCBwbGF5cyBuaWNlIHdpdGggdGhlIGFjY2Vzc2libGUgYXV0b2NvbXBsZXRlIGNvbXBvbmVudC5cclxuLy8gSSBkaWQgY29uc2lkZXIgc3ViY2xhc3NpbmcgdGhlIE1PSidzIGFkZC1hbm90aGVyIGNvbXBvbmVudCxcclxuLy8gYnV0IGl0IHdvdWxkIGhhdmUgYmVlbiBzbyBjb3VwbGVkIHRoYXQgaXQgd291bGQndmUgcHJvYmFibHkgYnJva2VuIG9uIGFuIHVwZGF0ZSBvZiB0aGUgTU9KIGxpYnJhcnkuXHJcbi8vIFNvIGluc3RlYWQgd2UgZm9ya2VkIGl0IGFuZCBtYWRlIG91ciBvd24gdmVyc2lvbi5cclxuXHJcbi8vdG9kbzogd2hlbiBhY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZSBjcmVhdGVzIHRoZSBpbnB1dCwgaXQgZG9lc24ndCBoYW5kbGUgdGhlIGFyaWEtZGVzY3JpYmVkYnkgY29ycmVjdGx5Li4uXHJcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbHBoYWdvdi9hY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZS9pc3N1ZXMvNTg5XHJcblxyXG4vL3RvZG86IHVzZSB0aGUgaW5kZXguZC50cyBmcm9tIGhlcmUuLi5cclxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2FscGhhZ292L2FjY2Vzc2libGUtYXV0b2NvbXBsZXRlL2lzc3Vlcy81MzVcclxuZGVjbGFyZSBjb25zdCBhY2Nlc3NpYmxlQXV0b2NvbXBsZXRlOiBhbnk7XHJcblxyXG50eXBlIENhbGxiYWNrID0gKGVsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiB2b2lkO1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZCA9IHdpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQgfHwge307XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZUFkZEFub3RoZXIoKTogdm9pZCB7XHJcbiAgICAvL3RvZG86IHN1cHBvcnQgb3B0aW9ucyB3aXRoIHNjb3BlP1xyXG4gICAgdmFyICRhZGRBbm90aGVycyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLW1vZHVsZT1cImZoLWFkZC1hbm90aGVyXCJdJyk7XHJcblxyXG5cdCRhZGRBbm90aGVycy5mb3JFYWNoKGZ1bmN0aW9uICgkYWRkQW5vdGhlcikge1xyXG5cdFx0bmV3IHdpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlcigkYWRkQW5vdGhlcik7XHJcbiAgICB9KTtcclxufVxyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyID0gZnVuY3Rpb24gKGNvbnRhaW5lcikge1xyXG5cdHRoaXMuY29udGFpbmVyID0gJChjb250YWluZXIpO1xyXG5cdHRoaXMuaW5kZXggPSAwO1xyXG5cclxuXHRpZiAodGhpcy5jb250YWluZXIuZGF0YSgnZmgtYWRkLWFub3RoZXItaW5pdGlhbGlzZWQnKSkge1xyXG5cdFx0cmV0dXJuXHJcblx0fVxyXG5cclxuXHQvL3RvZG86IHRoaXMgaXMgYSBiaXQgaGFja3kgLSBmaW5kIGEgYmV0dGVyIHdheSB0byBkbyB0aGlzXHJcblx0dmFyIGZ1bmN0aW9uTmFtZSA9IGNvbnRhaW5lci5nZXRBdHRyaWJ1dGUoJ2RhdGEtZmgtYWRkLWFub3RoZXItY2FsbGJhY2snKTtcclxuXHJcblx0dGhpcy5jYWxsYmFjayA9IG51bGw7XHJcblx0ZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uICgpIHtcclxuXHRcdGlmICh0eXBlb2Ygd2luZG93W2Z1bmN0aW9uTmFtZV0gPT09ICdmdW5jdGlvbicpIHtcclxuXHRcdFx0dGhpcy5jYWxsYmFjayA9IHdpbmRvd1tmdW5jdGlvbk5hbWVdO1xyXG5cdFx0XHR0aGlzLmNhbGxiYWNrKGNvbnRhaW5lcik7XHJcblx0XHR9XHJcblx0fS5iaW5kKHRoaXMpKTtcclxuXHJcblx0dGhpcy5jb250YWluZXIuZGF0YSgnZmgtYWRkLWFub3RoZXItaW5pdGlhbGlzZWQnLCB0cnVlKTtcclxuXHJcblx0dGhpcy5jb250YWluZXIub24oJ2NsaWNrJywgJy5maC1hZGQtYW5vdGhlcl9fcmVtb3ZlLWJ1dHRvbicsICQucHJveHkodGhpcywgJ29uUmVtb3ZlQnV0dG9uQ2xpY2snKSk7XHJcblx0dGhpcy5jb250YWluZXIub24oJ2NsaWNrJywgJy5maC1hZGQtYW5vdGhlcl9fYWRkLWJ1dHRvbicsICQucHJveHkodGhpcywgJ29uQWRkQnV0dG9uQ2xpY2snKSk7XHJcblx0dGhpcy5jb250YWluZXIuZmluZCgnLmZoLWFkZC1hbm90aGVyX19hZGQtYnV0dG9uLCBmaC1hZGQtYW5vdGhlcl9fcmVtb3ZlLWJ1dHRvbicpLnByb3AoJ3R5cGUnLCAnYnV0dG9uJyk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLm9uQWRkQnV0dG9uQ2xpY2sgPSBmdW5jdGlvbiAoZSkge1xyXG5cdHZhciBpdGVtID0gdGhpcy5nZXROZXdJdGVtKCk7XHJcblx0Ly90aGlzLnJlc2V0SXRlbShpdGVtKTtcclxuXHR2YXIgZmlyc3RJdGVtID0gdGhpcy5nZXRJdGVtcygpLmZpcnN0KCk7XHJcblx0aWYgKCF0aGlzLmhhc1JlbW92ZUJ1dHRvbihmaXJzdEl0ZW0pKSB7XHJcblx0XHR0aGlzLmNyZWF0ZVJlbW92ZUJ1dHRvbihmaXJzdEl0ZW0pO1xyXG5cdH1cclxuXHR0aGlzLmdldEl0ZW1zKCkubGFzdCgpLmFmdGVyKGl0ZW0pO1xyXG5cdGl0ZW0uZmluZCgnaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QnKS5maXJzdCgpLmZvY3VzKCk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmhhc1JlbW92ZUJ1dHRvbiA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcblx0cmV0dXJuIGl0ZW0uZmluZCgnLmZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJykubGVuZ3RoO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5nZXRJdGVtcyA9IGZ1bmN0aW9uICgpIHtcclxuXHRyZXR1cm4gdGhpcy5jb250YWluZXIuZmluZCgnLmZoLWFkZC1hbm90aGVyX19pdGVtJyk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmdldE5ld0l0ZW0gPSBmdW5jdGlvbiAoKSB7IC8vOiBKUXVlcnk8SFRNTEVsZW1lbnQ+IC8vSFRNTEVsZW1lbnQge1xyXG4gICAgLy8gZ2V0IHRoZSBmaXJzdCBpdGVtIGFuZCBjbG9uZSBpdFxyXG4gICAgY29uc3QgaXRlbXMgPSB0aGlzLmdldEl0ZW1zKCk7XHJcbiAgICBjb25zdCBpdGVtID0gaXRlbXNbMF0uY2xvbmVOb2RlKHRydWUpIGFzIEhUTUxFbGVtZW50O1xyXG5cclxuICAgIC8vIGZpbmQgdGhlIGF1dG9jb21wbGV0ZSB3cmFwcGVycyBhbmQgcmVtb3ZlIHRoZSBlbGVtZW50cyB0aGF0IGFyZSBhZGRlZCBieSBhY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZVxyXG4gICAgY29uc3QgYXV0b2NvbXBsZXRlV3JhcHBlcnMgPSBpdGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJy5hdXRvY29tcGxldGVfX3dyYXBwZXInKTtcclxuICAgIGF1dG9jb21wbGV0ZVdyYXBwZXJzLmZvckVhY2god3JhcHBlciA9PiB7XHJcbiAgICAgICAgaWYgKHdyYXBwZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlKSB7XHJcblx0XHRcdHdyYXBwZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHdyYXBwZXIucGFyZW50Tm9kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG5cdHZhciAkaXRlbSA9ICQoaXRlbSk7XHJcblxyXG5cdC8vIHVwZGF0ZSB0aGUgaWQgYW5kIG5hbWUgYXR0cmlidXRlc1xyXG5cdHRoaXMudXBkYXRlQXR0cmlidXRlcygrK3RoaXMuaW5kZXgsICRpdGVtKTtcclxuXHJcblx0dGhpcy5yZXNldEl0ZW0oJGl0ZW0pO1xyXG5cclxuXHQvLyBjYWxsIHRoZSBjYWxsYmFjayB3aGljaCBuZWVkcyB0byBhcHBseSBhY2Nlc3NpYmlsaXR5LWF1dG9jb21wbGV0ZSBlbmhhbmNlbWVudHMgdG8gdGhlIG5ldyBpdGVtXHJcblx0aWYgKHR5cGVvZiB0aGlzLmNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XHJcblx0XHR0aGlzLmNhbGxiYWNrKGl0ZW0pO1xyXG5cdH1cclxuXHJcbiAgICAvLyBDcmVhdGUgYSByZW1vdmUgYnV0dG9uIGlmIGl0IGRvZXNuJ3QgZXhpc3RcclxuICAgIGlmICghdGhpcy5oYXNSZW1vdmVCdXR0b24oJGl0ZW0pKSB7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVSZW1vdmVCdXR0b24oJGl0ZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiAkaXRlbTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUudXBkYXRlQXR0cmlidXRlcyA9IGZ1bmN0aW9uIChpbmRleCwgaXRlbSkge1xyXG5cdGl0ZW0uZmluZCgnW2RhdGEtbmFtZV0nKS5lYWNoKGZ1bmN0aW9uIChpLCBlbCkge1xyXG5cdFx0dmFyIG9yaWdpbmFsSWQgPSBlbC5pZFxyXG5cclxuXHRcdGVsLm5hbWUgPSAkKGVsKS5hdHRyKCdkYXRhLW5hbWUnKS5yZXBsYWNlKC8laW5kZXglLywgaW5kZXgpO1xyXG5cdFx0ZWwuaWQgPSAkKGVsKS5hdHRyKCdkYXRhLWlkJykucmVwbGFjZSgvJWluZGV4JS8sIGluZGV4KTtcclxuXHJcblx0XHR2YXIgbGFiZWwgPSAkKGVsKS5zaWJsaW5ncygnbGFiZWwnKVswXSB8fCAkKGVsKS5wYXJlbnRzKCdsYWJlbCcpWzBdIHx8IGl0ZW0uZmluZCgnW2Zvcj1cIicgKyBvcmlnaW5hbElkICsgJ1wiXScpWzBdO1xyXG5cdFx0bGFiZWwuaHRtbEZvciA9IGVsLmlkO1xyXG5cdH0pO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5jcmVhdGVSZW1vdmVCdXR0b24gPSBmdW5jdGlvbiAoaXRlbSkge1xyXG5cdGl0ZW0uYXBwZW5kKCc8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBjbGFzcz1cImdvdnVrLWJ1dHRvbiBnb3Z1ay1idXR0b24tLXNlY29uZGFyeSBmaC1hZGQtYW5vdGhlcl9fcmVtb3ZlLWJ1dHRvblwiPlJlbW92ZTwvYnV0dG9uPicpO1xyXG59O1xyXG5cclxuLy8gc2VsZWN0IHRoZSBvcHRpb24gd2l0aCB0aGUgcGFzc2VkIHZhbHVlLCBldmVuIGlmIGl0J3MgZGlzYWJsZWRcclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5zZWxlY3RPcHRpb24gPSBmdW5jdGlvbiAoZWwsIHZhbHVlKSB7XHJcblx0bGV0IG9wdGlvbiA9IGVsLnF1ZXJ5U2VsZWN0b3IoYG9wdGlvblt2YWx1ZT1cIiR7dmFsdWV9XCJdYCk7XHJcblx0aWYgKG9wdGlvbikge1xyXG5cdFx0bGV0IHdhc0Rpc2FibGVkID0gb3B0aW9uLmRpc2FibGVkO1xyXG5cdFx0b3B0aW9uLmRpc2FibGVkID0gZmFsc2U7XHJcblx0XHRlbC52YWx1ZSA9IHZhbHVlO1xyXG5cdFx0b3B0aW9uLmRpc2FibGVkID0gd2FzRGlzYWJsZWQ7XHJcblx0fVxyXG59XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLnJlc2V0SXRlbSA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcblx0Ly8gYWNjZXNzaWJpbGUtYXV0b2NvbXBsZXRlIGFkZHMgYW4gaW5wdXQgKHdpdGhvdXQgZGF0YS1uYW1lIG9yIGRhdGEtaWQpXHJcblx0Ly8gc28gd2UgYmxhbmsgYWxsIGlucHV0IGNvbnRyb2xzXHJcblxyXG5cdHZhciBUaGlzID0gdGhpcztcclxuICAgIGl0ZW0uZmluZCgnaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QnKS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWwpIHtcclxuXHRcdGlmIChlbC50eXBlID09ICdjaGVja2JveCcgfHwgZWwudHlwZSA9PSAncmFkaW8nKSB7XHJcblx0XHRcdGVsLmNoZWNrZWQgPSBmYWxzZTtcclxuXHRcdH1cclxuICAgICAgICBlbHNlIGlmIChlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdzZWxlY3QnKSB7XHJcbiAgICAgICAgICAgIC8vdG9kbzogdGhpcyBzaG91bGQgc2V0IHRoZSB2YWx1ZSB0byBkZWZhdWx0VmFsdWUgYXMgcGFzc2VkIHRvIGVuaGFuY2VTZWxlY3RFbGVtZW50XHJcbiAgICAgICAgICAgIC8vVGhpcy5zZWxlY3RPcHRpb24oZWwsICcnKTtcclxuXHJcbiAgICAgICAgICAgIC8vJCgnc2VsZWN0I2dlbnJlcyBvcHRpb25bc2VsZWN0ZWRdJykucmVtb3ZlQXR0cihcInNlbGVjdGVkXCIpO1xyXG5cclxuICAgICAgICAgICAgbGV0IG9sZE9wdGlvbiA9IGVsLnF1ZXJ5U2VsZWN0b3IoJ29wdGlvbltzZWxlY3RlZF0nKTtcclxuICAgICAgICAgICAgb2xkT3B0aW9uLnJlbW92ZUF0dHJpYnV0ZShcInNlbGVjdGVkXCIpO1xyXG5cclxuICAgICAgICAgICAgbGV0IG9wdGlvbiA9IGVsLnF1ZXJ5U2VsZWN0b3IoJ29wdGlvblt2YWx1ZT1cIlwiXScpO1xyXG4gICAgICAgICAgICBpZiAob3B0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgd2FzRGlzYWJsZWQgPSBvcHRpb24uZGlzYWJsZWQ7XHJcbiAgICAgICAgICAgICAgICBvcHRpb24uZGlzYWJsZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGVsLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICBvcHRpb24uZGlzYWJsZWQgPSB3YXNEaXNhYmxlZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGVsLnZhbHVlID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLm9uUmVtb3ZlQnV0dG9uQ2xpY2sgPSBmdW5jdGlvbiAoZSkge1xyXG5cdCQoZS5jdXJyZW50VGFyZ2V0KS5wYXJlbnRzKCcuZmgtYWRkLWFub3RoZXJfX2l0ZW0nKS5yZW1vdmUoKTtcclxuXHR2YXIgaXRlbXMgPSB0aGlzLmdldEl0ZW1zKCk7XHJcblx0aWYgKGl0ZW1zLmxlbmd0aCA9PT0gMSkge1xyXG5cdFx0aXRlbXMuZmluZCgnLmZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJykucmVtb3ZlKCk7XHJcblx0fVxyXG5cdHRoaXMuZm9jdXNIZWFkaW5nKCk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmZvY3VzSGVhZGluZyA9IGZ1bmN0aW9uICgpIHtcclxuXHR0aGlzLmNvbnRhaW5lci5maW5kKCcuZmgtYWRkLWFub3RoZXJfX2hlYWRpbmcnKS5mb2N1cygpO1xyXG59O1xyXG4iXX0=
