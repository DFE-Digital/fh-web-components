// A version of the MOJ's add-another component that plays nice with the accessible autocomplete component.
// I did consider subclassing the MOJ's add-another component,
// but it would have been so coupled that it would've probably broken on an update of the MOJ library.
// So instead we forked it and made our own version.
window.FamilyHubsFrontend = window.FamilyHubsFrontend || {};
export function initializeAddAnother() {
    //todo: support options with scope?
    var $addAnothers = document.querySelectorAll('[data-module="fh-add-another"]');
    $addAnothers.forEach(function ($addAnother) {
        new window.FamilyHubsFrontend.AddAnother($addAnother);
    });
}
window.FamilyHubsFrontend.AddAnother = function (container) {
    this.container = $(container);
    this.callback = null;
    if (this.container.data('fh-add-another-initialised')) {
        return;
    }
    this.container.data('fh-add-another-initialised', true);
    this.container.on('click', '.fh-add-another__remove-button', $.proxy(this, 'onRemoveButtonClick'));
    this.container.on('click', '.fh-add-another__add-button', $.proxy(this, 'onAddButtonClick'));
    this.container.find('.fh-add-another__add-button, fh-add-another__remove-button').prop('type', 'button');
};
window.FamilyHubsFrontend.AddAnother.prototype.setCallback = function (callback) {
    this.callback = callback;
};
window.FamilyHubsFrontend.AddAnother.prototype.onAddButtonClick = function (e) {
    var item = this.getNewItem();
    this.resetItem(item);
    var firstItem = this.getItems().first();
    if (!this.hasRemoveButton(firstItem)) {
        this.createRemoveButton(firstItem);
    }
    this.getItems().last().after(item);
    item.find('input, textarea, select').first().focus();
};
window.FamilyHubsFrontend.AddAnother.prototype.hasRemoveButton = function (item) {
    return item.find('.fh-add-another__remove-button').length;
};
window.FamilyHubsFrontend.AddAnother.prototype.getItems = function () {
    return this.container.find('.fh-add-another__item');
};
window.FamilyHubsFrontend.AddAnother.prototype.getNewItem = function () {
    // get the first item and clone it
    const items = this.getItems();
    const item = items[0].cloneNode(true);
    // find the autocomplete wrappers and remove the elements that are added by accessible-autocomplete
    const autocompleteWrappers = item.querySelectorAll('.autocomplete__wrapper');
    autocompleteWrappers.forEach(wrapper => {
        if (wrapper.parentNode.parentNode) {
            wrapper.parentNode.parentNode.removeChild(wrapper.parentNode);
        }
    });
    var $item = $(item);
    // update the id and name attributes
    this.updateAttributes(items.length, $item);
    // call the callback which needs to apply accessibility enhancements to the new item
    if (typeof this.callback === 'function') {
        this.callback(item);
    }
    //todo: this is just a poc, and will be replaced by the callback
    //const languageSelects = item.querySelectorAll("[id^='language-']") as NodeListOf<HTMLSelectElement>;
    //languageSelects.forEach(select => {
    //    accessibleAutocomplete.enhanceSelectElement({
    //        name: 'languageName',
    //        defaultValue: '',
    //        selectElement: select
    //    });
    //});
    // Create a remove button if it doesn't exist
    if (!this.hasRemoveButton($item)) {
        this.createRemoveButton($item);
    }
    return $item;
};
window.FamilyHubsFrontend.AddAnother.prototype.updateAttributes = function (index, item) {
    item.find('[data-name]').each(function (i, el) {
        var originalId = el.id;
        el.name = $(el).attr('data-name').replace(/%index%/, index);
        el.id = $(el).attr('data-id').replace(/%index%/, index);
        var label = $(el).siblings('label')[0] || $(el).parents('label')[0] || item.find('[for="' + originalId + '"]')[0];
        label.htmlFor = el.id;
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.createRemoveButton = function (item) {
    item.append('<button type="button" class="govuk-button govuk-button--secondary fh-add-another__remove-button">Remove</button>');
};
window.FamilyHubsFrontend.AddAnother.prototype.resetItem = function (item) {
    // accessibile-autocomplete adds an input (without data-name or data-id)
    // so we blank all input controls
    item.find('input, textarea, select').each(function (index, el) {
        if (el.type == 'checkbox' || el.type == 'radio') {
            el.checked = false;
        }
        else {
            el.value = '';
        }
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.onRemoveButtonClick = function (e) {
    $(e.currentTarget).parents('.fh-add-another__item').remove();
    var items = this.getItems();
    if (items.length === 1) {
        items.find('.fh-add-another__remove-button').remove();
    }
    items.each($.proxy(function (index, el) {
        this.updateAttributes(index, $(el));
    }, this));
    this.focusHeading();
};
window.FamilyHubsFrontend.AddAnother.prototype.focusHeading = function () {
    this.container.find('.fh-add-another__heading').focus();
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWRkLWFub3RoZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsMkdBQTJHO0FBQzNHLDhEQUE4RDtBQUM5RCxzR0FBc0c7QUFDdEcsb0RBQW9EO0FBa0JwRCxNQUFNLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxDQUFDLGtCQUFrQixJQUFJLEVBQUUsQ0FBQztBQUU1RCxNQUFNLFVBQVUsb0JBQW9CO0lBQ2hDLG1DQUFtQztJQUNuQyxJQUFJLFlBQVksR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztJQUUvRSxZQUFZLENBQUMsT0FBTyxDQUFDLFVBQVUsV0FBVztRQUM1QyxJQUFJLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDcEQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsR0FBRyxVQUFVLFNBQVM7SUFDekQsSUFBSSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7SUFFOUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFFckIsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxFQUFFLENBQUM7UUFDdkQsT0FBTTtJQUNQLENBQUM7SUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUV4RCxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxDQUFDO0lBQ25HLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxrQkFBa0IsQ0FBQyxD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LEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDckMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDVixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7QUFDckIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsWUFBWSxHQUFHO0lBQzdELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDekQsQ0FBQyxDQUFDIiwiZmlsZSI6ImNvbXBvbmVudHMvYWRkLWFub3RoZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBIHZlcnNpb24gb2YgdGhlIE1PSidzIGFkZC1hbm90aGVyIGNvbXBvbmVudCB0aGF0IHBsYXlzIG5pY2Ugd2l0aCB0aGUgYWNjZXNzaWJsZSBhdXRvY29tcGxldGUgY29tcG9uZW50LlxyXG4vLyBJIGRpZCBjb25zaWRlciBzdWJjbGFzc2luZyB0aGUgTU9KJ3MgYWRkLWFub3RoZXIgY29tcG9uZW50LFxyXG4vLyBidXQgaXQgd291bGQgaGF2ZSBiZWVuIHNvIGNvdXBsZWQgdGhhdCBpdCB3b3VsZCd2ZSBwcm9iYWJseSBicm9rZW4gb24gYW4gdXBkYXRlIG9mIHRoZSBNT0ogbGlicmFyeS5cclxuLy8gU28gaW5zdGVhZCB3ZSBmb3JrZWQgaXQgYW5kIG1hZGUgb3VyIG93biB2ZXJzaW9uLlxyXG5cclxuLy90b2RvOiB0aGUgY3JlYXRlZCBhY2Nlc3NpYmxlICBpbnB1dCB3aGVuIGFkZGluZyBkb2Vzbid0IGhhdmUgdGhlIGlkL25hbWUgZGF0YSBhdHRycywgc28gd2UgZ2V0IGR1cGUgaWRzXHJcbi8vdG9kbzogdGhlcmUgc2VlbXMgdG8gYmUgYSBidWcgaW4gYWNjZXNzaWJsZS1hdXRvY29tcGxldGUgd2hlcmUgdGhlIGlucHV0IGl0IGNyZWF0ZXMgaGFzIHRoZSBzYW1lIGlkIGFzIHRoZSBzZWxlY3RcclxuLy90b2RvOiB3ZSBuZWVkIHRvIGluaXRpYWxpc2UgdGhlIGFjY2Vzc2libGUgYXV0b2NvbXBsZXRlIG9uIHRoZSBuZXcgaXRlbVxyXG4vL3RvZG86IHdoZW4gZW5oYW5jaW5nIHRoZSBzZWxlY3QgaW4gYWNjZXNzaWJsZS1hdXRvY29tcGxldGUsIGl0IHJldHVybnMgdGhlIG5hbWUgcmF0aGVyIHRoYW4gdGhlIHZhbHVlXHJcbi8vIHRoZXJlJ3MgYSB3b3JrYXJvdW5kLi4uXHJcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbHBoYWdvdi9hY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZS9pc3N1ZXMvMzg3XHJcbi8vIGJ1dCB3ZSBjb3VsZCB3ZSByb2xsIGl0IGludG8gb3VyIGFkZC1hbm90aGVyIGNvbXBvbmVudD9cclxuLy90b2RvOiB3aGVuIGFjY2Vzc2libGUtYXV0b2NvbXBsZXRlIGNyZWF0ZXMgdGhlIGlucHV0LCBpdCBkb2Vzbid0IGhhbmRsZSB0aGUgYXJpYS1kZXNjcmliZWRieSBjb3JyZWN0bHkuLi5cclxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2FscGhhZ292L2FjY2Vzc2libGUtYXV0b2NvbXBsZXRlL2lzc3Vlcy81ODlcclxuXHJcbi8vdG9kbzogdXNlIHRoZSBpbmRleC5kLnRzIGZyb20gaGVyZS4uLlxyXG4vLyBodHRwczovL2dpdGh1Yi5jb20vYWxwaGFnb3YvYWNjZXNzaWJsZS1hdXRvY29tcGxldGUvaXNzdWVzLzUzNVxyXG5kZWNsYXJlIGNvbnN0IGFjY2Vzc2libGVBdXRvY29tcGxldGU6IGFueTtcclxuXHJcbnR5cGUgQ2FsbGJhY2sgPSAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IHZvaWQ7XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kID0gd2luZG93LkZhbWlseUh1YnNGcm9udGVuZCB8fCB7fTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplQWRkQW5vdGhlcigpOiB2b2lkIHtcclxuICAgIC8vdG9kbzogc3VwcG9ydCBvcHRpb25zIHdpdGggc2NvcGU/XHJcbiAgICB2YXIgJGFkZEFub3RoZXJzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtbW9kdWxlPVwiZmgtYWRkLWFub3RoZXJcIl0nKTtcclxuXHJcbiAgICAkYWRkQW5vdGhlcnMuZm9yRWFjaChmdW5jdGlvbiAoJGFkZEFub3RoZXIpIHtcclxuXHRcdG5ldyB3aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIoJGFkZEFub3RoZXIpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlciA9IGZ1bmN0aW9uIChjb250YWluZXIpIHtcclxuXHR0aGlzLmNvbnRhaW5lciA9ICQoY29udGFpbmVyKTtcclxuXHJcblx0dGhpcy5jYWxsYmFjayA9IG51bGw7XHJcblxyXG5cdGlmICh0aGlzLmNvbnRhaW5lci5kYXRhKCdmaC1hZGQtYW5vdGhlci1pbml0aWFsaXNlZCcpKSB7XHJcblx0XHRyZXR1cm5cclxuXHR9XHJcblxyXG5cdHRoaXMuY29udGFpbmVyLmRhdGEoJ2ZoLWFkZC1hbm90aGVyLWluaXRpYWxpc2VkJywgdHJ1ZSk7XHJcblxyXG5cdHRoaXMuY29udGFpbmVyLm9uKCdjbGljaycsICcuZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nLCAkLnByb3h5KHRoaXMsICdvblJlbW92ZUJ1dHRvbkNsaWNrJykpO1xyXG5cdHRoaXMuY29udGFpbmVyLm9uKCdjbGljaycsICcuZmgtYWRkLWFub3RoZXJfX2FkZC1idXR0b24nLCAkLnByb3h5KHRoaXMsICdvbkFkZEJ1dHRvbkNsaWNrJykpO1xyXG5cdHRoaXMuY29udGFpbmVyLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9fYWRkLWJ1dHRvbiwgZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nKS5wcm9wKCd0eXBlJywgJ2J1dHRvbicpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5zZXRDYWxsYmFjayA9IGZ1bmN0aW9uIChjYWxsYmFjazogQ2FsbGJhY2spIHtcclxuXHR0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLm9uQWRkQnV0dG9uQ2xpY2sgPSBmdW5jdGlvbiAoZSkge1xyXG5cdHZhciBpdGVtID0gdGhpcy5nZXROZXdJdGVtKCk7XHJcblx0dGhpcy5yZXNldEl0ZW0oaXRlbSk7XHJcblx0dmFyIGZpcnN0SXRlbSA9IHRoaXMuZ2V0SXRlbXMoKS5maXJzdCgpO1xyXG5cdGlmICghdGhpcy5oYXNSZW1vdmVCdXR0b24oZmlyc3RJdGVtKSkge1xyXG5cdFx0dGhpcy5jcmVhdGVSZW1vdmVCdXR0b24oZmlyc3RJdGVtKTtcclxuXHR9XHJcblx0dGhpcy5nZXRJdGVtcygpLmxhc3QoKS5hZnRlcihpdGVtKTtcclxuXHRpdGVtLmZpbmQoJ2lucHV0LCB0ZXh0YXJlYSwgc2VsZWN0JykuZmlyc3QoKS5mb2N1cygpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5oYXNSZW1vdmVCdXR0b24gPSBmdW5jdGlvbiAoaXRlbSkge1xyXG5cdHJldHVybiBpdGVtLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9fcmVtb3ZlLWJ1dHRvbicpLmxlbmd0aDtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuZ2V0SXRlbXMgPSBmdW5jdGlvbiAoKSB7XHJcblx0cmV0dXJuIHRoaXMuY29udGFpbmVyLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9faXRlbScpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5nZXROZXdJdGVtID0gZnVuY3Rpb24gKCkgeyAvLzogSlF1ZXJ5PEhUTUxFbGVtZW50PiAvL0hUTUxFbGVtZW50IHtcclxuICAgIC8vIGdldCB0aGUgZmlyc3QgaXRlbSBhbmQgY2xvbmUgaXRcclxuICAgIGNvbnN0IGl0ZW1zID0gdGhpcy5nZXRJdGVtcygpO1xyXG4gICAgY29uc3QgaXRlbSA9IGl0ZW1zWzBdLmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MRWxlbWVudDtcclxuXHJcbiAgICAvLyBmaW5kIHRoZSBhdXRvY29tcGxldGUgd3JhcHBlcnMgYW5kIHJlbW92ZSB0aGUgZWxlbWVudHMgdGhhdCBhcmUgYWRkZWQgYnkgYWNjZXNzaWJsZS1hdXRvY29tcGxldGVcclxuICAgIGNvbnN0IGF1dG9jb21wbGV0ZVdyYXBwZXJzID0gaXRlbS5xdWVyeVNlbGVjdG9yQWxsKCcuYXV0b2NvbXBsZXRlX193cmFwcGVyJyk7XHJcbiAgICBhdXRvY29tcGxldGVXcmFwcGVycy5mb3JFYWNoKHdyYXBwZXIgPT4ge1xyXG4gICAgICAgIGlmICh3cmFwcGVyLnBhcmVudE5vZGUucGFyZW50Tm9kZSkge1xyXG5cdFx0XHR3cmFwcGVyLnBhcmVudE5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh3cmFwcGVyLnBhcmVudE5vZGUpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuXHR2YXIgJGl0ZW0gPSAkKGl0ZW0pO1xyXG5cclxuXHQvLyB1cGRhdGUgdGhlIGlkIGFuZCBuYW1lIGF0dHJpYnV0ZXNcclxuXHR0aGlzLnVwZGF0ZUF0dHJpYnV0ZXMoaXRlbXMubGVuZ3RoLCAkaXRlbSk7XHJcblxyXG5cdC8vIGNhbGwgdGhlIGNhbGxiYWNrIHdoaWNoIG5lZWRzIHRvIGFwcGx5IGFjY2Vzc2liaWxpdHkgZW5oYW5jZW1lbnRzIHRvIHRoZSBuZXcgaXRlbVxyXG5cdGlmICh0eXBlb2YgdGhpcy5jYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xyXG5cdFx0dGhpcy5jYWxsYmFjayhpdGVtKTtcclxuXHR9XHJcblxyXG5cdC8vdG9kbzogdGhpcyBpcyBqdXN0IGEgcG9jLCBhbmQgd2lsbCBiZSByZXBsYWNlZCBieSB0aGUgY2FsbGJhY2tcclxuICAgIC8vY29uc3QgbGFuZ3VhZ2VTZWxlY3RzID0gaXRlbS5xdWVyeVNlbGVjdG9yQWxsKFwiW2lkXj0nbGFuZ3VhZ2UtJ11cIikgYXMgTm9kZUxpc3RPZjxIVE1MU2VsZWN0RWxlbWVudD47XHJcbiAgICAvL2xhbmd1YWdlU2VsZWN0cy5mb3JFYWNoKHNlbGVjdCA9PiB7XHJcbiAgICAvLyAgICBhY2Nlc3NpYmxlQXV0b2NvbXBsZXRlLmVuaGFuY2VTZWxlY3RFbGVtZW50KHtcclxuICAgIC8vICAgICAgICBuYW1lOiAnbGFuZ3VhZ2VOYW1lJyxcclxuICAgIC8vICAgICAgICBkZWZhdWx0VmFsdWU6ICcnLFxyXG4gICAgLy8gICAgICAgIHNlbGVjdEVsZW1lbnQ6IHNlbGVjdFxyXG4gICAgLy8gICAgfSk7XHJcbiAgICAvL30pO1xyXG5cclxuICAgIC8vIENyZWF0ZSBhIHJlbW92ZSBidXR0b24gaWYgaXQgZG9lc24ndCBleGlzdFxyXG4gICAgaWYgKCF0aGlzLmhhc1JlbW92ZUJ1dHRvbigkaXRlbSkpIHtcclxuICAgICAgICB0aGlzLmNyZWF0ZVJlbW92ZUJ1dHRvbigkaXRlbSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuICRpdGVtO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS51cGRhdGVBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKGluZGV4LCBpdGVtKSB7XHJcblx0aXRlbS5maW5kKCdbZGF0YS1uYW1lXScpLmVhY2goZnVuY3Rpb24gKGksIGVsKSB7XHJcblx0XHR2YXIgb3JpZ2luYWxJZCA9IGVsLmlkXHJcblxyXG5cdFx0ZWwubmFtZSA9ICQoZWwpLmF0dHIoJ2RhdGEtbmFtZScpLnJlcGxhY2UoLyVpbmRleCUvLCBpbmRleCk7XHJcblx0XHRlbC5pZCA9ICQoZWwpLmF0dHIoJ2RhdGEtaWQnKS5yZXBsYWNlKC8laW5kZXglLywgaW5kZXgpO1xyXG5cclxuXHRcdHZhciBsYWJlbCA9ICQoZWwpLnNpYmxpbmdzKCdsYWJlbCcpWzBdIHx8ICQoZWwpLnBhcmVudHMoJ2xhYmVsJylbMF0gfHwgaXRlbS5maW5kKCdbZm9yPVwiJyArIG9yaWdpbmFsSWQgKyAnXCJdJylbMF07XHJcblx0XHRsYWJlbC5odG1sRm9yID0gZWwuaWQ7XHJcblx0fSk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmNyZWF0ZVJlbW92ZUJ1dHRvbiA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcblx0aXRlbS5hcHBlbmQoJzxidXR0b24gdHlwZT1cImJ1dHRvblwiIGNsYXNzPVwiZ292dWstYnV0dG9uIGdvdnVrLWJ1dHRvbi0tc2Vjb25kYXJ5IGZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uXCI+UmVtb3ZlPC9idXR0b24+Jyk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLnJlc2V0SXRlbSA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcblx0Ly8gYWNjZXNzaWJpbGUtYXV0b2NvbXBsZXRlIGFkZHMgYW4gaW5wdXQgKHdpdGhvdXQgZGF0YS1uYW1lIG9yIGRhdGEtaWQpXHJcblx0Ly8gc28gd2UgYmxhbmsgYWxsIGlucHV0IGNvbnRyb2xzXHJcbiAgICBpdGVtLmZpbmQoJ2lucHV0LCB0ZXh0YXJlYSwgc2VsZWN0JykuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsKSB7XHJcbiAgICAgICAgaWYgKGVsLnR5cGUgPT0gJ2NoZWNrYm94JyB8fCBlbC50eXBlID09ICdyYWRpbycpIHtcclxuICAgICAgICAgICAgZWwuY2hlY2tlZCA9IGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGVsLnZhbHVlID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLm9uUmVtb3ZlQnV0dG9uQ2xpY2sgPSBmdW5jdGlvbiAoZSkge1xyXG5cdCQoZS5jdXJyZW50VGFyZ2V0KS5wYXJlbnRzKCcuZmgtYWRkLWFub3RoZXJfX2l0ZW0nKS5yZW1vdmUoKTtcclxuXHR2YXIgaXRlbXMgPSB0aGlzLmdldEl0ZW1zKCk7XHJcblx0aWYgKGl0ZW1zLmxlbmd0aCA9PT0gMSkge1xyXG5cdFx0aXRlbXMuZmluZCgnLmZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJykucmVtb3ZlKCk7XHJcblx0fVxyXG5cdGl0ZW1zLmVhY2goJC5wcm94eShmdW5jdGlvbiAoaW5kZXgsIGVsKSB7XHJcblx0XHR0aGlzLnVwZGF0ZUF0dHJpYnV0ZXMoaW5kZXgsICQoZWwpKTtcclxuXHR9LCB0aGlzKSk7XHJcblx0dGhpcy5mb2N1c0hlYWRpbmcoKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuZm9jdXNIZWFkaW5nID0gZnVuY3Rpb24gKCkge1xyXG5cdHRoaXMuY29udGFpbmVyLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9faGVhZGluZycpLmZvY3VzKCk7XHJcbn07XHJcbiJdfQ==
