// A version of the MOJ's add-another component that plays nice with the accessible autocomplete component.
// I did consider subclassing the MOJ's add-another component,
// but it would have been so coupled that it would've probably broken on an update of the MOJ library.
// So instead we forked it and made our own version.
window.FamilyHubsFrontend = window.FamilyHubsFrontend || {};
export function initializeAddAnother() {
    //todo: support options with scope?
    var $addAnothers = document.querySelectorAll('[data-module="fh-add-another"]');
    $addAnothers.forEach(function ($addAnother) {
        new window.FamilyHubsFrontend.AddAnother($addAnother);
    });
}
window.FamilyHubsFrontend.AddAnother = function (container) {
    this.container = $(container);
    if (this.container.data('fh-add-another-initialised')) {
        return;
    }
    //todo: this is a bit hacky - find a better way to do this
    var functionName = container.getAttribute('data-fh-add-another-callback');
    this.callback = null;
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window[functionName] === 'function') {
            this.callback = window[functionName];
            this.callback(container);
        }
    }.bind(this));
    this.container.data('fh-add-another-initialised', true);
    this.container.on('click', '.fh-add-another__remove-button', $.proxy(this, 'onRemoveButtonClick'));
    this.container.on('click', '.fh-add-another__add-button', $.proxy(this, 'onAddButtonClick'));
    this.container.find('.fh-add-another__add-button, fh-add-another__remove-button').prop('type', 'button');
};
window.FamilyHubsFrontend.AddAnother.prototype.onAddButtonClick = function (e) {
    var item = this.getNewItem();
    this.resetItem(item);
    var firstItem = this.getItems().first();
    if (!this.hasRemoveButton(firstItem)) {
        this.createRemoveButton(firstItem);
    }
    this.getItems().last().after(item);
    item.find('input, textarea, select').first().focus();
};
window.FamilyHubsFrontend.AddAnother.prototype.hasRemoveButton = function (item) {
    return item.find('.fh-add-another__remove-button').length;
};
window.FamilyHubsFrontend.AddAnother.prototype.getItems = function () {
    return this.container.find('.fh-add-another__item');
};
window.FamilyHubsFrontend.AddAnother.prototype.getNewItem = function () {
    // get the first item and clone it
    const items = this.getItems();
    const item = items[0].cloneNode(true);
    // find the autocomplete wrappers and remove the elements that are added by accessible-autocomplete
    const autocompleteWrappers = item.querySelectorAll('.autocomplete__wrapper');
    autocompleteWrappers.forEach(wrapper => {
        if (wrapper.parentNode.parentNode) {
            wrapper.parentNode.parentNode.removeChild(wrapper.parentNode);
        }
    });
    var $item = $(item);
    // update the id and name attributes
    this.updateAttributes(items.length, $item);
    // call the callback which needs to apply accessibility-autocomplete enhancements to the new item
    if (typeof this.callback === 'function') {
        this.callback(item);
    }
    // Create a remove button if it doesn't exist
    if (!this.hasRemoveButton($item)) {
        this.createRemoveButton($item);
    }
    return $item;
};
window.FamilyHubsFrontend.AddAnother.prototype.updateAttributes = function (index, item) {
    item.find('[data-name]').each(function (i, el) {
        var originalId = el.id;
        el.name = $(el).attr('data-name').replace(/%index%/, index);
        el.id = $(el).attr('data-id').replace(/%index%/, index);
        var label = $(el).siblings('label')[0] || $(el).parents('label')[0] || item.find('[for="' + originalId + '"]')[0];
        label.htmlFor = el.id;
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.createRemoveButton = function (item) {
    item.append('<button type="button" class="govuk-button govuk-button--secondary fh-add-another__remove-button">Remove</button>');
};
window.FamilyHubsFrontend.AddAnother.prototype.resetItem = function (item) {
    // accessibile-autocomplete adds an input (without data-name or data-id)
    // so we blank all input controls
    item.find('input, textarea, select').each(function (index, el) {
        if (el.type == 'checkbox' || el.type == 'radio') {
            el.checked = false;
        }
        else {
            el.value = '';
        }
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.onRemoveButtonClick = function (e) {
    $(e.currentTarget).parents('.fh-add-another__item').remove();
    var items = this.getItems();
    if (items.length === 1) {
        items.find('.fh-add-another__remove-button').remove();
    }
    //todo: use bind instead of proxy
    items.each($.proxy(function (index, el) {
        this.updateAttributes(index, $(el));
    }, this));
    this.focusHeading();
};
window.FamilyHubsFrontend.AddAnother.prototype.focusHeading = function () {
    this.container.find('.fh-add-another__heading').focus();
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWRkLWFub3RoZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsMkdBQTJHO0FBQzNHLDhEQUE4RDtBQUM5RCxzR0FBc0c7QUFDdEcsb0RBQW9EO0FBWXBELE1BQU0sQ0FBQyxrQkFBa0IsR0FBRyxNQUFNLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBRTVELE1BQU0sVUFBVSxvQkFBb0I7SUFDaEMsbUNBQW1DO0lBQ25DLElBQUksWUFBWSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBRWxGLFlBQVksQ0FBQyxPQUFPLENBQUMsVUFBVSxXQUFXO1FBQ3pDLElBQUksTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxHQUFHLFVBQVUsU0FBUztJQUN6RCxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUU5QixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLDRCQUE0QixDQUFDLEVBQUUsQ0FBQztRQUN2RCxPQUFNO0lBQ1AsQ0FBQztJQUVELDBEQUEwRDtJQUMxRCxJQUFJLFlBQVksR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLDhCQUE4QixDQUFDLENBQUM7SUFFMUUsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDckIsUUFBUSxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixFQUFFO1FBQzdDLElBQUksT0FBTyxNQUFNLENBQUMsWUFBWSxDQUFDLEtBQUssVUFBVSxFQUFFLENBQUM7WUFDaEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDckMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMxQixDQUFDO0lBQ0Ys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QUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsS0FBSyxFQUFFLEVBQUU7UUFDckMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNyQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUNWLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUNyQixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUc7SUFDN0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUN6RCxDQUFDLENBQUMiLCJmaWxlIjoiY29tcG9uZW50cy9hZGQtYW5vdGhlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEEgdmVyc2lvbiBvZiB0aGUgTU9KJ3MgYWRkLWFub3RoZXIgY29tcG9uZW50IHRoYXQgcGxheXMgbmljZSB3aXRoIHRoZSBhY2Nlc3NpYmxlIGF1dG9jb21wbGV0ZSBjb21wb25lbnQuXHJcbi8vIEkgZGlkIGNvbnNpZGVyIHN1YmNsYXNzaW5nIHRoZSBNT0oncyBhZGQtYW5vdGhlciBjb21wb25lbnQsXHJcbi8vIGJ1dCBpdCB3b3VsZCBoYXZlIGJlZW4gc28gY291cGxlZCB0aGF0IGl0IHdvdWxkJ3ZlIHByb2JhYmx5IGJyb2tlbiBvbiBhbiB1cGRhdGUgb2YgdGhlIE1PSiBsaWJyYXJ5LlxyXG4vLyBTbyBpbnN0ZWFkIHdlIGZvcmtlZCBpdCBhbmQgbWFkZSBvdXIgb3duIHZlcnNpb24uXHJcblxyXG4vL3RvZG86IHdoZW4gYWRkIGEgY291cGxlIG9mIHRpbWVzLCB0aGVuIHJlbW92ZSB0aGUgbWlkZGxlLCB0aGUgaWQgb2YgdGhlIGlucHV0IGFuZCBsYWJlbHMgZ2V0IG91dCBvZiB3aGFja1xyXG4vL3RvZG86IHdoZW4gYWNjZXNzaWJsZS1hdXRvY29tcGxldGUgY3JlYXRlcyB0aGUgaW5wdXQsIGl0IGRvZXNuJ3QgaGFuZGxlIHRoZSBhcmlhLWRlc2NyaWJlZGJ5IGNvcnJlY3RseS4uLlxyXG4vLyBodHRwczovL2dpdGh1Yi5jb20vYWxwaGFnb3YvYWNjZXNzaWJsZS1hdXRvY29tcGxldGUvaXNzdWVzLzU4OVxyXG5cclxuLy90b2RvOiB1c2UgdGhlIGluZGV4LmQudHMgZnJvbSBoZXJlLi4uXHJcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbHBoYWdvdi9hY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZS9pc3N1ZXMvNTM1XHJcbmRlY2xhcmUgY29uc3QgYWNjZXNzaWJsZUF1dG9jb21wbGV0ZTogYW55O1xyXG5cclxudHlwZSBDYWxsYmFjayA9IChlbGVtZW50OiBIVE1MRWxlbWVudCkgPT4gdm9pZDtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQgPSB3aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kIHx8IHt9O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluaXRpYWxpemVBZGRBbm90aGVyKCk6IHZvaWQge1xyXG4gICAgLy90b2RvOiBzdXBwb3J0IG9wdGlvbnMgd2l0aCBzY29wZT9cclxuICAgIHZhciAkYWRkQW5vdGhlcnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1tb2R1bGU9XCJmaC1hZGQtYW5vdGhlclwiXScpO1xyXG5cclxuXHQkYWRkQW5vdGhlcnMuZm9yRWFjaChmdW5jdGlvbiAoJGFkZEFub3RoZXIpIHtcclxuXHRcdG5ldyB3aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIoJGFkZEFub3RoZXIpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlciA9IGZ1bmN0aW9uIChjb250YWluZXIpIHtcclxuXHR0aGlzLmNvbnRhaW5lciA9ICQoY29udGFpbmVyKTtcclxuXHJcblx0aWYgKHRoaXMuY29udGFpbmVyLmRhdGEoJ2ZoLWFkZC1hbm90aGVyLWluaXRpYWxpc2VkJykpIHtcclxuXHRcdHJldHVyblxyXG5cdH1cclxuXHJcblx0Ly90b2RvOiB0aGlzIGlzIGEgYml0IGhhY2t5IC0gZmluZCBhIGJldHRlciB3YXkgdG8gZG8gdGhpc1xyXG5cdHZhciBmdW5jdGlvbk5hbWUgPSBjb250YWluZXIuZ2V0QXR0cmlidXRlKCdkYXRhLWZoLWFkZC1hbm90aGVyLWNhbGxiYWNrJyk7XHJcblxyXG5cdHRoaXMuY2FsbGJhY2sgPSBudWxsO1xyXG5cdGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbiAoKSB7XHJcblx0XHRpZiAodHlwZW9mIHdpbmRvd1tmdW5jdGlvbk5hbWVdID09PSAnZnVuY3Rpb24nKSB7XHJcblx0XHRcdHRoaXMuY2FsbGJhY2sgPSB3aW5kb3dbZnVuY3Rpb25OYW1lXTtcclxuXHRcdFx0dGhpcy5jYWxsYmFjayhjb250YWluZXIpO1xyXG5cdFx0fVxyXG5cdH0uYmluZCh0aGlzKSk7XHJcblxyXG5cdHRoaXMuY29udGFpbmVyLmRhdGEoJ2ZoLWFkZC1hbm90aGVyLWluaXRpYWxpc2VkJywgdHJ1ZSk7XHJcblxyXG5cdHRoaXMuY29udGFpbmVyLm9uKCdjbGljaycsICcuZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nLCAkLnByb3h5KHRoaXMsICdvblJlbW92ZUJ1dHRvbkNsaWNrJykpO1xyXG5cdHRoaXMuY29udGFpbmVyLm9uKCdjbGljaycsICcuZmgtYWRkLWFub3RoZXJfX2FkZC1idXR0b24nLCAkLnByb3h5KHRoaXMsICdvbkFkZEJ1dHRvbkNsaWNrJykpO1xyXG5cdHRoaXMuY29udGFpbmVyLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9fYWRkLWJ1dHRvbiwgZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nKS5wcm9wKCd0eXBlJywgJ2J1dHRvbicpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5vbkFkZEJ1dHRvbkNsaWNrID0gZnVuY3Rpb24gKGUpIHtcclxuXHR2YXIgaXRlbSA9IHRoaXMuZ2V0TmV3SXRlbSgpO1xyXG5cdHRoaXMucmVzZXRJdGVtKGl0ZW0pO1xyXG5cdHZhciBmaXJzdEl0ZW0gPSB0aGlzLmdldEl0ZW1zKCkuZmlyc3QoKTtcclxuXHRpZiAoIXRoaXMuaGFzUmVtb3ZlQnV0dG9uKGZpcnN0SXRlbSkpIHtcclxuXHRcdHRoaXMuY3JlYXRlUmVtb3ZlQnV0dG9uKGZpcnN0SXRlbSk7XHJcblx0fVxyXG5cdHRoaXMuZ2V0SXRlbXMoKS5sYXN0KCkuYWZ0ZXIoaXRlbSk7XHJcblx0aXRlbS5maW5kKCdpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCcpLmZpcnN0KCkuZm9jdXMoKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuaGFzUmVtb3ZlQnV0dG9uID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuXHRyZXR1cm4gaXRlbS5maW5kKCcuZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nKS5sZW5ndGg7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmdldEl0ZW1zID0gZnVuY3Rpb24gKCkge1xyXG5cdHJldHVybiB0aGlzLmNvbnRhaW5lci5maW5kKCcuZmgtYWRkLWFub3RoZXJfX2l0ZW0nKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuZ2V0TmV3SXRlbSA9IGZ1bmN0aW9uICgpIHsgLy86IEpRdWVyeTxIVE1MRWxlbWVudD4gLy9IVE1MRWxlbWVudCB7XHJcbiAgICAvLyBnZXQgdGhlIGZpcnN0IGl0ZW0gYW5kIGNsb25lIGl0XHJcbiAgICBjb25zdCBpdGVtcyA9IHRoaXMuZ2V0SXRlbXMoKTtcclxuICAgIGNvbnN0IGl0ZW0gPSBpdGVtc1swXS5jbG9uZU5vZGUodHJ1ZSkgYXMgSFRNTEVsZW1lbnQ7XHJcblxyXG4gICAgLy8gZmluZCB0aGUgYXV0b2NvbXBsZXRlIHdyYXBwZXJzIGFuZCByZW1vdmUgdGhlIGVsZW1lbnRzIHRoYXQgYXJlIGFkZGVkIGJ5IGFjY2Vzc2libGUtYXV0b2NvbXBsZXRlXHJcbiAgICBjb25zdCBhdXRvY29tcGxldGVXcmFwcGVycyA9IGl0ZW0ucXVlcnlTZWxlY3RvckFsbCgnLmF1dG9jb21wbGV0ZV9fd3JhcHBlcicpO1xyXG4gICAgYXV0b2NvbXBsZXRlV3JhcHBlcnMuZm9yRWFjaCh3cmFwcGVyID0+IHtcclxuICAgICAgICBpZiAod3JhcHBlci5wYXJlbnROb2RlLnBhcmVudE5vZGUpIHtcclxuXHRcdFx0d3JhcHBlci5wYXJlbnROb2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQod3JhcHBlci5wYXJlbnROb2RlKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcblx0dmFyICRpdGVtID0gJChpdGVtKTtcclxuXHJcblx0Ly8gdXBkYXRlIHRoZSBpZCBhbmQgbmFtZSBhdHRyaWJ1dGVzXHJcblx0dGhpcy51cGRhdGVBdHRyaWJ1dGVzKGl0ZW1zLmxlbmd0aCwgJGl0ZW0pO1xyXG5cclxuXHQvLyBjYWxsIHRoZSBjYWxsYmFjayB3aGljaCBuZWVkcyB0byBhcHBseSBhY2Nlc3NpYmlsaXR5LWF1dG9jb21wbGV0ZSBlbmhhbmNlbWVudHMgdG8gdGhlIG5ldyBpdGVtXHJcblx0aWYgKHR5cGVvZiB0aGlzLmNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XHJcblx0XHR0aGlzLmNhbGxiYWNrKGl0ZW0pO1xyXG5cdH1cclxuXHJcbiAgICAvLyBDcmVhdGUgYSByZW1vdmUgYnV0dG9uIGlmIGl0IGRvZXNuJ3QgZXhpc3RcclxuICAgIGlmICghdGhpcy5oYXNSZW1vdmVCdXR0b24oJGl0ZW0pKSB7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVSZW1vdmVCdXR0b24oJGl0ZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiAkaXRlbTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUudXBkYXRlQXR0cmlidXRlcyA9IGZ1bmN0aW9uIChpbmRleCwgaXRlbSkge1xyXG5cdGl0ZW0uZmluZCgnW2RhdGEtbmFtZV0nKS5lYWNoKGZ1bmN0aW9uIChpLCBlbCkge1xyXG5cdFx0dmFyIG9yaWdpbmFsSWQgPSBlbC5pZFxyXG5cclxuXHRcdGVsLm5hbWUgPSAkKGVsKS5hdHRyKCdkYXRhLW5hbWUnKS5yZXBsYWNlKC8laW5kZXglLywgaW5kZXgpO1xyXG5cdFx0ZWwuaWQgPSAkKGVsKS5hdHRyKCdkYXRhLWlkJykucmVwbGFjZSgvJWluZGV4JS8sIGluZGV4KTtcclxuXHJcblx0XHR2YXIgbGFiZWwgPSAkKGVsKS5zaWJsaW5ncygnbGFiZWwnKVswXSB8fCAkKGVsKS5wYXJlbnRzKCdsYWJlbCcpWzBdIHx8IGl0ZW0uZmluZCgnW2Zvcj1cIicgKyBvcmlnaW5hbElkICsgJ1wiXScpWzBdO1xyXG5cdFx0bGFiZWwuaHRtbEZvciA9IGVsLmlkO1xyXG5cdH0pO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5jcmVhdGVSZW1vdmVCdXR0b24gPSBmdW5jdGlvbiAoaXRlbSkge1xyXG5cdGl0ZW0uYXBwZW5kKCc8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBjbGFzcz1cImdvdnVrLWJ1dHRvbiBnb3Z1ay1idXR0b24tLXNlY29uZGFyeSBmaC1hZGQtYW5vdGhlcl9fcmVtb3ZlLWJ1dHRvblwiPlJlbW92ZTwvYnV0dG9uPicpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5yZXNldEl0ZW0gPSBmdW5jdGlvbiAoaXRlbSkge1xyXG5cdC8vIGFjY2Vzc2liaWxlLWF1dG9jb21wbGV0ZSBhZGRzIGFuIGlucHV0ICh3aXRob3V0IGRhdGEtbmFtZSBvciBkYXRhLWlkKVxyXG5cdC8vIHNvIHdlIGJsYW5rIGFsbCBpbnB1dCBjb250cm9sc1xyXG4gICAgaXRlbS5maW5kKCdpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCcpLmVhY2goZnVuY3Rpb24gKGluZGV4LCBlbCkge1xyXG4gICAgICAgIGlmIChlbC50eXBlID09ICdjaGVja2JveCcgfHwgZWwudHlwZSA9PSAncmFkaW8nKSB7XHJcbiAgICAgICAgICAgIGVsLmNoZWNrZWQgPSBmYWxzZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBlbC52YWx1ZSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5vblJlbW92ZUJ1dHRvbkNsaWNrID0gZnVuY3Rpb24gKGUpIHtcclxuXHQkKGUuY3VycmVudFRhcmdldCkucGFyZW50cygnLmZoLWFkZC1hbm90aGVyX19pdGVtJykucmVtb3ZlKCk7XHJcblx0dmFyIGl0ZW1zID0gdGhpcy5nZXRJdGVtcygpO1xyXG5cdGlmIChpdGVtcy5sZW5ndGggPT09IDEpIHtcclxuXHRcdGl0ZW1zLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9fcmVtb3ZlLWJ1dHRvbicpLnJlbW92ZSgpO1xyXG5cdH1cclxuXHQvL3RvZG86IHVzZSBiaW5kIGluc3RlYWQgb2YgcHJveHlcclxuXHRpdGVtcy5lYWNoKCQucHJveHkoZnVuY3Rpb24gKGluZGV4LCBlbCkge1xyXG5cdFx0dGhpcy51cGRhdGVBdHRyaWJ1dGVzKGluZGV4LCAkKGVsKSk7XHJcblx0fSwgdGhpcykpO1xyXG5cdHRoaXMuZm9jdXNIZWFkaW5nKCk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmZvY3VzSGVhZGluZyA9IGZ1bmN0aW9uICgpIHtcclxuXHR0aGlzLmNvbnRhaW5lci5maW5kKCcuZmgtYWRkLWFub3RoZXJfX2hlYWRpbmcnKS5mb2N1cygpO1xyXG59O1xyXG4iXX0=
