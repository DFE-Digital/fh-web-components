// A version of the MOJ's add-another component that plays nice with the accessible autocomplete component.
// I did consider subclassing the MOJ's add-another component,
// but it would have been so coupled that it would've probably broken on an update of the MOJ library.
// So instead we forked it and made our own version.
window.FamilyHubsFrontend = window.FamilyHubsFrontend || {};
export function initializeAddAnother() {
    //todo: support options with scope?
    var $addAnothers = document.querySelectorAll('[data-module="fh-add-another"]');
    $addAnothers.forEach(function ($addAnother) {
        new window.FamilyHubsFrontend.AddAnother($addAnother);
    });
}
window.FamilyHubsFrontend.AddAnother = function (container) {
    this.container = $(container);
    this.index = 0;
    if (this.container.data('fh-add-another-initialised')) {
        return;
    }
    //todo: this is a bit hacky - find a better way to do this
    var functionName = container.getAttribute('data-fh-add-another-callback');
    this.callback = null;
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window[functionName] === 'function') {
            this.callback = window[functionName];
            this.callback(container);
        }
    }.bind(this));
    this.container.data('fh-add-another-initialised', true);
    this.container.on('click', '.fh-add-another__remove-button', $.proxy(this, 'onRemoveButtonClick'));
    this.container.on('click', '.fh-add-another__add-button', $.proxy(this, 'onAddButtonClick'));
    this.container.find('.fh-add-another__add-button, fh-add-another__remove-button').prop('type', 'button');
};
window.FamilyHubsFrontend.AddAnother.prototype.onAddButtonClick = function (e) {
    var item = this.getNewItem();
    this.resetItem(item);
    var firstItem = this.getItems().first();
    if (!this.hasRemoveButton(firstItem)) {
        this.createRemoveButton(firstItem);
    }
    this.getItems().last().after(item);
    item.find('input, textarea, select').first().focus();
};
window.FamilyHubsFrontend.AddAnother.prototype.hasRemoveButton = function (item) {
    return item.find('.fh-add-another__remove-button').length;
};
window.FamilyHubsFrontend.AddAnother.prototype.getItems = function () {
    return this.container.find('.fh-add-another__item');
};
window.FamilyHubsFrontend.AddAnother.prototype.getNewItem = function () {
    // get the first item and clone it
    const items = this.getItems();
    const item = items[0].cloneNode(true);
    // find the autocomplete wrappers and remove the elements that are added by accessible-autocomplete
    const autocompleteWrappers = item.querySelectorAll('.autocomplete__wrapper');
    autocompleteWrappers.forEach(wrapper => {
        if (wrapper.parentNode.parentNode) {
            wrapper.parentNode.parentNode.removeChild(wrapper.parentNode);
        }
    });
    var $item = $(item);
    // update the id and name attributes
    this.updateAttributes(++this.index, $item);
    // call the callback which needs to apply accessibility-autocomplete enhancements to the new item
    if (typeof this.callback === 'function') {
        this.callback(item);
    }
    // Create a remove button if it doesn't exist
    if (!this.hasRemoveButton($item)) {
        this.createRemoveButton($item);
    }
    return $item;
};
window.FamilyHubsFrontend.AddAnother.prototype.updateAttributes = function (index, item) {
    item.find('[data-name]').each(function (i, el) {
        var originalId = el.id;
        el.name = $(el).attr('data-name').replace(/%index%/, index);
        el.id = $(el).attr('data-id').replace(/%index%/, index);
        var label = $(el).siblings('label')[0] || $(el).parents('label')[0] || item.find('[for="' + originalId + '"]')[0];
        label.htmlFor = el.id;
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.createRemoveButton = function (item) {
    item.append('<button type="button" class="govuk-button govuk-button--secondary fh-add-another__remove-button">Remove</button>');
};
// select the option with the passed value, even if it's disabled
window.FamilyHubsFrontend.AddAnother.prototype.selectOption = function (el, value) {
    let option = el.querySelector(`option[value="${value}"]`);
    if (option) {
        let wasDisabled = option.disabled;
        option.disabled = false;
        el.value = value;
        //option.disabled = wasDisabled;
    }
};
window.FamilyHubsFrontend.AddAnother.prototype.resetItem = function (item) {
    // accessibile-autocomplete adds an input (without data-name or data-id)
    // so we blank all input controls
    var This = this;
    item.find('input, textarea, select').each(function (index, el) {
        if (el.type == 'checkbox' || el.type == 'radio') {
            el.checked = false;
        }
        else if (el.tagName.toLowerCase() === 'select') {
            //todo: this should set the value to defaultValue as passed to enhanceSelectElement
            This.selectOption(el, '');
        }
        else {
            el.value = '';
        }
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.onRemoveButtonClick = function (e) {
    $(e.currentTarget).parents('.fh-add-another__item').remove();
    var items = this.getItems();
    if (items.length === 1) {
        items.find('.fh-add-another__remove-button').remove();
    }
    this.focusHeading();
};
window.FamilyHubsFrontend.AddAnother.prototype.focusHeading = function () {
    this.container.find('.fh-add-another__heading').focus();
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWRkLWFub3RoZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsMkdBQTJHO0FBQzNHLDhEQUE4RDtBQUM5RCxzR0FBc0c7QUFDdEcsb0RBQW9EO0FBV3BELE1BQU0sQ0FBQyxrQkFBa0IsR0FBRyxNQUFNLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBRTVELE1BQU0sVUFBVSxvQkFBb0I7SUFDaEMsbUNBQW1DO0lBQ25DLElBQUksWUFBWSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBRWxGLFlBQVksQ0FBQyxPQUFPLENBQUMsVUFBVSxXQUFXO1FBQ3pDLElBQUksTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxHQUFHLFVBQVUsU0FBUztJQUN6RCxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM5QixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztJQUVmLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsNEJBQTRCLENBQUMsRUFBRSxDQUFDO1FBQ3ZELE9BQU07SUFDUCxDQUFDO0lBRUQsMERBQTBEO0lBQzFELElBQUksWUFBWSxHQUFHLFNBQVMsQ0FBQyxZQUFZLENBQUMsOEJBQThCLENBQUMsQ0FBQztJQUUxRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztJQUNyQixRQUFRLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUU7UUFDN0MsSUFBSSxPQUFPLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUNoRCxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsUUFBUSxD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LFdBQVcsRUFBRSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ2hELG1GQUFtRjtZQUNuRixJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNyQixDQUFDO2FBQU0sQ0FBQztZQUNKLEVBQUUsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLG1CQUFtQixHQUFHLFVBQVUsQ0FBQztJQUMvRSxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQzdELElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM1QixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDeEIsS0FBSyxDQUFDLElBQUksQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3ZELENBQUM7SUFDRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7QUFDckIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsWUFBWSxHQUFHO0lBQzdELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDekQsQ0FBQyxDQUFDIiwiZmlsZSI6ImNvbXBvbmVudHMvYWRkLWFub3RoZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBIHZlcnNpb24gb2YgdGhlIE1PSidzIGFkZC1hbm90aGVyIGNvbXBvbmVudCB0aGF0IHBsYXlzIG5pY2Ugd2l0aCB0aGUgYWNjZXNzaWJsZSBhdXRvY29tcGxldGUgY29tcG9uZW50LlxyXG4vLyBJIGRpZCBjb25zaWRlciBzdWJjbGFzc2luZyB0aGUgTU9KJ3MgYWRkLWFub3RoZXIgY29tcG9uZW50LFxyXG4vLyBidXQgaXQgd291bGQgaGF2ZSBiZWVuIHNvIGNvdXBsZWQgdGhhdCBpdCB3b3VsZCd2ZSBwcm9iYWJseSBicm9rZW4gb24gYW4gdXBkYXRlIG9mIHRoZSBNT0ogbGlicmFyeS5cclxuLy8gU28gaW5zdGVhZCB3ZSBmb3JrZWQgaXQgYW5kIG1hZGUgb3VyIG93biB2ZXJzaW9uLlxyXG5cclxuLy90b2RvOiB3aGVuIGFjY2Vzc2libGUtYXV0b2NvbXBsZXRlIGNyZWF0ZXMgdGhlIGlucHV0LCBpdCBkb2Vzbid0IGhhbmRsZSB0aGUgYXJpYS1kZXNjcmliZWRieSBjb3JyZWN0bHkuLi5cclxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2FscGhhZ292L2FjY2Vzc2libGUtYXV0b2NvbXBsZXRlL2lzc3Vlcy81ODlcclxuXHJcbi8vdG9kbzogdXNlIHRoZSBpbmRleC5kLnRzIGZyb20gaGVyZS4uLlxyXG4vLyBodHRwczovL2dpdGh1Yi5jb20vYWxwaGFnb3YvYWNjZXNzaWJsZS1hdXRvY29tcGxldGUvaXNzdWVzLzUzNVxyXG5kZWNsYXJlIGNvbnN0IGFjY2Vzc2libGVBdXRvY29tcGxldGU6IGFueTtcclxuXHJcbnR5cGUgQ2FsbGJhY2sgPSAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IHZvaWQ7XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kID0gd2luZG93LkZhbWlseUh1YnNGcm9udGVuZCB8fCB7fTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplQWRkQW5vdGhlcigpOiB2b2lkIHtcclxuICAgIC8vdG9kbzogc3VwcG9ydCBvcHRpb25zIHdpdGggc2NvcGU/XHJcbiAgICB2YXIgJGFkZEFub3RoZXJzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtbW9kdWxlPVwiZmgtYWRkLWFub3RoZXJcIl0nKTtcclxuXHJcblx0JGFkZEFub3RoZXJzLmZvckVhY2goZnVuY3Rpb24gKCRhZGRBbm90aGVyKSB7XHJcblx0XHRuZXcgd2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyKCRhZGRBbm90aGVyKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIgPSBmdW5jdGlvbiAoY29udGFpbmVyKSB7XHJcblx0dGhpcy5jb250YWluZXIgPSAkKGNvbnRhaW5lcik7XHJcblx0dGhpcy5pbmRleCA9IDA7XHJcblxyXG5cdGlmICh0aGlzLmNvbnRhaW5lci5kYXRhKCdmaC1hZGQtYW5vdGhlci1pbml0aWFsaXNlZCcpKSB7XHJcblx0XHRyZXR1cm5cclxuXHR9XHJcblxyXG5cdC8vdG9kbzogdGhpcyBpcyBhIGJpdCBoYWNreSAtIGZpbmQgYSBiZXR0ZXIgd2F5IHRvIGRvIHRoaXNcclxuXHR2YXIgZnVuY3Rpb25OYW1lID0gY29udGFpbmVyLmdldEF0dHJpYnV0ZSgnZGF0YS1maC1hZGQtYW5vdGhlci1jYWxsYmFjaycpO1xyXG5cclxuXHR0aGlzLmNhbGxiYWNrID0gbnVsbDtcclxuXHRkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24gKCkge1xyXG5cdFx0aWYgKHR5cGVvZiB3aW5kb3dbZnVuY3Rpb25OYW1lXSA9PT0gJ2Z1bmN0aW9uJykge1xyXG5cdFx0XHR0aGlzLmNhbGxiYWNrID0gd2luZG93W2Z1bmN0aW9uTmFtZV07XHJcblx0XHRcdHRoaXMuY2FsbGJhY2soY29udGFpbmVyKTtcclxuXHRcdH1cclxuXHR9LmJpbmQodGhpcykpO1xyXG5cclxuXHR0aGlzLmNvbnRhaW5lci5kYXRhKCdmaC1hZGQtYW5vdGhlci1pbml0aWFsaXNlZCcsIHRydWUpO1xyXG5cclxuXHR0aGlzLmNvbnRhaW5lci5vbignY2xpY2snLCAnLmZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJywgJC5wcm94eSh0aGlzLCAnb25SZW1vdmVCdXR0b25DbGljaycpKTtcclxuXHR0aGlzLmNvbnRhaW5lci5vbignY2xpY2snLCAnLmZoLWFkZC1hbm90aGVyX19hZGQtYnV0dG9uJywgJC5wcm94eSh0aGlzLCAnb25BZGRCdXR0b25DbGljaycpKTtcclxuXHR0aGlzLmNvbnRhaW5lci5maW5kKCcuZmgtYWRkLWFub3RoZXJfX2FkZC1idXR0b24sIGZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJykucHJvcCgndHlwZScsICdidXR0b24nKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUub25BZGRCdXR0b25DbGljayA9IGZ1bmN0aW9uIChlKSB7XHJcblx0dmFyIGl0ZW0gPSB0aGlzLmdldE5ld0l0ZW0oKTtcclxuXHR0aGlzLnJlc2V0SXRlbShpdGVtKTtcclxuXHR2YXIgZmlyc3RJdGVtID0gdGhpcy5nZXRJdGVtcygpLmZpcnN0KCk7XHJcblx0aWYgKCF0aGlzLmhhc1JlbW92ZUJ1dHRvbihmaXJzdEl0ZW0pKSB7XHJcblx0XHR0aGlzLmNyZWF0ZVJlbW92ZUJ1dHRvbihmaXJzdEl0ZW0pO1xyXG5cdH1cclxuXHR0aGlzLmdldEl0ZW1zKCkubGFzdCgpLmFmdGVyKGl0ZW0pO1xyXG5cdGl0ZW0uZmluZCgnaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QnKS5maXJzdCgpLmZvY3VzKCk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmhhc1JlbW92ZUJ1dHRvbiA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcblx0cmV0dXJuIGl0ZW0uZmluZCgnLmZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJykubGVuZ3RoO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5nZXRJdGVtcyA9IGZ1bmN0aW9uICgpIHtcclxuXHRyZXR1cm4gdGhpcy5jb250YWluZXIuZmluZCgnLmZoLWFkZC1hbm90aGVyX19pdGVtJyk7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmdldE5ld0l0ZW0gPSBmdW5jdGlvbiAoKSB7IC8vOiBKUXVlcnk8SFRNTEVsZW1lbnQ+IC8vSFRNTEVsZW1lbnQge1xyXG4gICAgLy8gZ2V0IHRoZSBmaXJzdCBpdGVtIGFuZCBjbG9uZSBpdFxyXG4gICAgY29uc3QgaXRlbXMgPSB0aGlzLmdldEl0ZW1zKCk7XHJcbiAgICBjb25zdCBpdGVtID0gaXRlbXNbMF0uY2xvbmVOb2RlKHRydWUpIGFzIEhUTUxFbGVtZW50O1xyXG5cclxuICAgIC8vIGZpbmQgdGhlIGF1dG9jb21wbGV0ZSB3cmFwcGVycyBhbmQgcmVtb3ZlIHRoZSBlbGVtZW50cyB0aGF0IGFyZSBhZGRlZCBieSBhY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZVxyXG4gICAgY29uc3QgYXV0b2NvbXBsZXRlV3JhcHBlcnMgPSBpdGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJy5hdXRvY29tcGxldGVfX3dyYXBwZXInKTtcclxuICAgIGF1dG9jb21wbGV0ZVdyYXBwZXJzLmZvckVhY2god3JhcHBlciA9PiB7XHJcbiAgICAgICAgaWYgKHdyYXBwZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlKSB7XHJcblx0XHRcdHdyYXBwZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHdyYXBwZXIucGFyZW50Tm9kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG5cdHZhciAkaXRlbSA9ICQoaXRlbSk7XHJcblxyXG5cdC8vIHVwZGF0ZSB0aGUgaWQgYW5kIG5hbWUgYXR0cmlidXRlc1xyXG5cdHRoaXMudXBkYXRlQXR0cmlidXRlcygrK3RoaXMuaW5kZXgsICRpdGVtKTtcclxuXHJcblx0Ly8gY2FsbCB0aGUgY2FsbGJhY2sgd2hpY2ggbmVlZHMgdG8gYXBwbHkgYWNjZXNzaWJpbGl0eS1hdXRvY29tcGxldGUgZW5oYW5jZW1lbnRzIHRvIHRoZSBuZXcgaXRlbVxyXG5cdGlmICh0eXBlb2YgdGhpcy5jYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xyXG5cdFx0dGhpcy5jYWxsYmFjayhpdGVtKTtcclxuXHR9XHJcblxyXG4gICAgLy8gQ3JlYXRlIGEgcmVtb3ZlIGJ1dHRvbiBpZiBpdCBkb2Vzbid0IGV4aXN0XHJcbiAgICBpZiAoIXRoaXMuaGFzUmVtb3ZlQnV0dG9uKCRpdGVtKSkge1xyXG4gICAgICAgIHRoaXMuY3JlYXRlUmVtb3ZlQnV0dG9uKCRpdGVtKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gJGl0ZW07XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLnVwZGF0ZUF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0pIHtcclxuXHRpdGVtLmZpbmQoJ1tkYXRhLW5hbWVdJykuZWFjaChmdW5jdGlvbiAoaSwgZWwpIHtcclxuXHRcdHZhciBvcmlnaW5hbElkID0gZWwuaWRcclxuXHJcblx0XHRlbC5uYW1lID0gJChlbCkuYXR0cignZGF0YS1uYW1lJykucmVwbGFjZSgvJWluZGV4JS8sIGluZGV4KTtcclxuXHRcdGVsLmlkID0gJChlbCkuYXR0cignZGF0YS1pZCcpLnJlcGxhY2UoLyVpbmRleCUvLCBpbmRleCk7XHJcblxyXG5cdFx0dmFyIGxhYmVsID0gJChlbCkuc2libGluZ3MoJ2xhYmVsJylbMF0gfHwgJChlbCkucGFyZW50cygnbGFiZWwnKVswXSB8fCBpdGVtLmZpbmQoJ1tmb3I9XCInICsgb3JpZ2luYWxJZCArICdcIl0nKVswXTtcclxuXHRcdGxhYmVsLmh0bWxGb3IgPSBlbC5pZDtcclxuXHR9KTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuY3JlYXRlUmVtb3ZlQnV0dG9uID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuXHRpdGVtLmFwcGVuZCgnPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgY2xhc3M9XCJnb3Z1ay1idXR0b24gZ292dWstYnV0dG9uLS1zZWNvbmRhcnkgZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b25cIj5SZW1vdmU8L2J1dHRvbj4nKTtcclxufTtcclxuXHJcbi8vIHNlbGVjdCB0aGUgb3B0aW9uIHdpdGggdGhlIHBhc3NlZCB2YWx1ZSwgZXZlbiBpZiBpdCdzIGRpc2FibGVkXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuc2VsZWN0T3B0aW9uID0gZnVuY3Rpb24gKGVsLCB2YWx1ZSkge1xyXG5cdGxldCBvcHRpb24gPSBlbC5xdWVyeVNlbGVjdG9yKGBvcHRpb25bdmFsdWU9XCIke3ZhbHVlfVwiXWApO1xyXG5cdGlmIChvcHRpb24pIHtcclxuXHRcdGxldCB3YXNEaXNhYmxlZCA9IG9wdGlvbi5kaXNhYmxlZDtcclxuXHRcdG9wdGlvbi5kaXNhYmxlZCA9IGZhbHNlO1xyXG5cdFx0ZWwudmFsdWUgPSB2YWx1ZTtcclxuXHRcdC8vb3B0aW9uLmRpc2FibGVkID0gd2FzRGlzYWJsZWQ7XHJcblx0fVxyXG59XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLnJlc2V0SXRlbSA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcblx0Ly8gYWNjZXNzaWJpbGUtYXV0b2NvbXBsZXRlIGFkZHMgYW4gaW5wdXQgKHdpdGhvdXQgZGF0YS1uYW1lIG9yIGRhdGEtaWQpXHJcblx0Ly8gc28gd2UgYmxhbmsgYWxsIGlucHV0IGNvbnRyb2xzXHJcblxyXG5cdHZhciBUaGlzID0gdGhpcztcclxuICAgIGl0ZW0uZmluZCgnaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QnKS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWwpIHtcclxuXHRcdGlmIChlbC50eXBlID09ICdjaGVja2JveCcgfHwgZWwudHlwZSA9PSAncmFkaW8nKSB7XHJcblx0XHRcdGVsLmNoZWNrZWQgPSBmYWxzZTtcclxuXHRcdH1cclxuXHRcdGVsc2UgaWYgKGVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3NlbGVjdCcpIHtcclxuXHRcdFx0Ly90b2RvOiB0aGlzIHNob3VsZCBzZXQgdGhlIHZhbHVlIHRvIGRlZmF1bHRWYWx1ZSBhcyBwYXNzZWQgdG8gZW5oYW5jZVNlbGVjdEVsZW1lbnRcclxuXHRcdFx0VGhpcy5zZWxlY3RPcHRpb24oZWwsICcnKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBlbC52YWx1ZSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5vblJlbW92ZUJ1dHRvbkNsaWNrID0gZnVuY3Rpb24gKGUpIHtcclxuXHQkKGUuY3VycmVudFRhcmdldCkucGFyZW50cygnLmZoLWFkZC1hbm90aGVyX19pdGVtJykucmVtb3ZlKCk7XHJcblx0dmFyIGl0ZW1zID0gdGhpcy5nZXRJdGVtcygpO1xyXG5cdGlmIChpdGVtcy5sZW5ndGggPT09IDEpIHtcclxuXHRcdGl0ZW1zLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9fcmVtb3ZlLWJ1dHRvbicpLnJlbW92ZSgpO1xyXG5cdH1cclxuXHR0aGlzLmZvY3VzSGVhZGluZygpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5mb2N1c0hlYWRpbmcgPSBmdW5jdGlvbiAoKSB7XHJcblx0dGhpcy5jb250YWluZXIuZmluZCgnLmZoLWFkZC1hbm90aGVyX19oZWFkaW5nJykuZm9jdXMoKTtcclxufTtcclxuIl19
