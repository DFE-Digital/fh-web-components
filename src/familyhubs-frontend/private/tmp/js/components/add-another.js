// A version of the MOJ's add-another component that plays nice with the accessible autocomplete component
// and works with errored fields.
// I did consider subclassing the MOJ's add-another component,
// but it would have been so coupled that it would've probably broken on an update of the MOJ library.
// So instead we forked it and made our own version.
//todo: when accessible-autocomplete creates the input, it doesn't handle the aria-describedby correctly...
// https://github.com/alphagov/accessible-autocomplete/issues/589
window.FamilyHubsFrontend = window.FamilyHubsFrontend || {};
export function initializeAddAnother() {
    //todo: support options with scope?
    var $addAnothers = document.querySelectorAll('[data-module="fh-add-another"]');
    $addAnothers.forEach(function ($addAnother) {
        new window.FamilyHubsFrontend.AddAnother($addAnother);
    });
}
window.FamilyHubsFrontend.AddAnother = function (container) {
    this.container = $(container);
    this.index = 0;
    if (this.container.data('fh-add-another-initialised')) {
        return;
    }
    //todo: this is a bit hacky - find a better way to do this
    var functionName = container.getAttribute('data-fh-add-another-callback');
    this.callback = null;
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window[functionName] === 'function') {
            this.callback = window[functionName];
            this.callback(container);
        }
    }.bind(this));
    this.container.data('fh-add-another-initialised', true);
    this.container.on('click', '.fh-add-another__remove-button', $.proxy(this, 'onRemoveButtonClick'));
    this.container.on('click', '.fh-add-another__add-button', $.proxy(this, 'onAddButtonClick'));
    this.container.find('.fh-add-another__add-button, fh-add-another__remove-button').prop('type', 'submit');
};
window.FamilyHubsFrontend.AddAnother.prototype.onAddButtonClick = function (e) {
    var item = this.getNewItem();
    var firstItem = this.getItems().first();
    if (!this.hasRemoveButton(firstItem)) {
        this.createRemoveButton(firstItem);
    }
    this.getItems().last().after(item);
    item.find('input, textarea, select').first().focus();
    e.preventDefault();
};
window.FamilyHubsFrontend.AddAnother.prototype.hasRemoveButton = function (item) {
    return item.find('.fh-add-another__remove-button').length;
};
window.FamilyHubsFrontend.AddAnother.prototype.getItems = function () {
    return this.container.find('.fh-add-another__item');
};
// todo: ? a better approach would be to have a template item that we clone,
// rather than having to strip the error from the first item
window.FamilyHubsFrontend.AddAnother.prototype.stripErrorFromNewItem = function (item) {
    // remove the govuk-form-group--error class from any divs that have it set
    item.querySelectorAll('div.govuk-form-group--error').forEach(function (el, index) {
        el.classList.remove('govuk-form-group--error');
    });
    // find all paragraphs with the class govuk-error-message and remove them
    item.querySelectorAll('p.govuk-error-message').forEach(function (el, index) {
        el.parentNode.removeChild(el);
    });
    // remove the govuk-select--error class from any selects that have it set
    item.querySelectorAll('select.govuk-select--error').forEach(function (el, index) {
        el.classList.remove('govuk-select--error');
    });
    // remove the govuk-input--error class from any inputs that have it set
    item.querySelectorAll('input.govuk-input--error').forEach(function (el, index) {
        el.classList.remove('govuk-input--error');
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.getNewItem = function () {
    // get the first item and clone it
    const items = this.getItems();
    const item = items[0].cloneNode(true);
    this.stripErrorFromNewItem(item);
    // find the autocomplete wrappers and remove the elements that are added by accessible-autocomplete
    const autocompleteWrappers = item.querySelectorAll('.autocomplete__wrapper');
    autocompleteWrappers.forEach(wrapper => {
        if (wrapper.parentNode.parentNode) {
            wrapper.parentNode.parentNode.removeChild(wrapper.parentNode);
        }
    });
    var $item = $(item);
    // update the id and name attributes
    this.updateAttributes(++this.index, $item);
    this.resetItem($item);
    // call the callback which needs to apply accessibility-autocomplete enhancements to the new item
    if (typeof this.callback === 'function') {
        this.callback(item);
    }
    // Create a remove button if it doesn't exist
    if (!this.hasRemoveButton($item)) {
        this.createRemoveButton($item);
    }
    return $item;
};
window.FamilyHubsFrontend.AddAnother.prototype.updateAttributes = function (index, item) {
    item.find('[data-name]').each(function (i, el) {
        var originalId = el.id;
        el.name = $(el).attr('data-name').replace(/%index%/, index);
        el.id = $(el).attr('data-id').replace(/%index%/, index);
        var label = $(el).siblings('label')[0] || $(el).parents('label')[0] || item.find('[for="' + originalId + '"]')[0];
        label.htmlFor = el.id;
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.createRemoveButton = function (item) {
    item.append('<button type="submit" class="govuk-button govuk-button--secondary fh-add-another__remove-button">Remove</button>');
};
window.FamilyHubsFrontend.AddAnother.prototype.resetItem = function (item) {
    // accessibile-autocomplete adds an input (without data-name or data-id)
    // so we blank all input controls
    item.find('input, textarea, select').each(function (index, el) {
        if (el.type == 'checkbox' || el.type == 'radio') {
            el.checked = false;
        }
        else {
            el.value = '';
        }
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.onRemoveButtonClick = function (e) {
    $(e.currentTarget).parents('.fh-add-another__item').remove();
    var items = this.getItems();
    if (items.length === 1) {
        items.find('.fh-add-another__remove-button').remove();
    }
    this.focusHeading();
    e.preventDefault();
};
window.FamilyHubsFrontend.AddAnother.prototype.focusHeading = function () {
    this.container.find('.fh-add-another__heading').focus();
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWRkLWFub3RoZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsMEdBQTBHO0FBQzFHLGlDQUFpQztBQUNqQyw4REFBOEQ7QUFDOUQsc0dBQXNHO0FBQ3RHLG9EQUFvRDtBQUVwRCwyR0FBMkc7QUFDM0csaUVBQWlFO0FBRWpFLE1BQU0sQ0FBQyxrQkFBa0IsR0FBRyxNQUFNLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDO0FBRTVELE1BQU0sVUFBVSxvQkFBb0I7SUFDaEMsbUNBQW1DO0lBQ25DLElBQUksWUFBWSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBRWxGLFlBQVksQ0FBQyxPQUFPLENBQUMsVUFBVSxXQUFXO1FBQ3pDLElBQUksTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxHQUFHLFVBQVUsU0FBUztJQUN6RCxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM5QixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztJQUVmLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsNEJBQTRCLENBQUMsRUFBRSxDQUFDO1FBQ3ZELE9BQU07SUFDUCxDQUFDO0lBRUQsMERBQTBEO0lBQzFELElBQUksWUFBWSxHQUFHLFNBQVMsQ0FBQyxZQUFZLENBQUMsOEJBQThCLENBQUMsQ0FBQztJQUUxRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztJQUNyQixRQUFRLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUU7UUFDN0MsSUFBSSxPQUFPLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUNoRCxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FB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RSxDQUFDO0lBQ3BCLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztBQUNwQixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUc7SUFDN0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUN6RCxDQUFDLENBQUMiLCJmaWxlIjoiY29tcG9uZW50cy9hZGQtYW5vdGhlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEEgdmVyc2lvbiBvZiB0aGUgTU9KJ3MgYWRkLWFub3RoZXIgY29tcG9uZW50IHRoYXQgcGxheXMgbmljZSB3aXRoIHRoZSBhY2Nlc3NpYmxlIGF1dG9jb21wbGV0ZSBjb21wb25lbnRcbi8vIGFuZCB3b3JrcyB3aXRoIGVycm9yZWQgZmllbGRzLlxuLy8gSSBkaWQgY29uc2lkZXIgc3ViY2xhc3NpbmcgdGhlIE1PSidzIGFkZC1hbm90aGVyIGNvbXBvbmVudCxcbi8vIGJ1dCBpdCB3b3VsZCBoYXZlIGJlZW4gc28gY291cGxlZCB0aGF0IGl0IHdvdWxkJ3ZlIHByb2JhYmx5IGJyb2tlbiBvbiBhbiB1cGRhdGUgb2YgdGhlIE1PSiBsaWJyYXJ5LlxuLy8gU28gaW5zdGVhZCB3ZSBmb3JrZWQgaXQgYW5kIG1hZGUgb3VyIG93biB2ZXJzaW9uLlxuXG4vL3RvZG86IHdoZW4gYWNjZXNzaWJsZS1hdXRvY29tcGxldGUgY3JlYXRlcyB0aGUgaW5wdXQsIGl0IGRvZXNuJ3QgaGFuZGxlIHRoZSBhcmlhLWRlc2NyaWJlZGJ5IGNvcnJlY3RseS4uLlxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2FscGhhZ292L2FjY2Vzc2libGUtYXV0b2NvbXBsZXRlL2lzc3Vlcy81ODlcblxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZCA9IHdpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQgfHwge307XG5cbmV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplQWRkQW5vdGhlcigpOiB2b2lkIHtcbiAgICAvL3RvZG86IHN1cHBvcnQgb3B0aW9ucyB3aXRoIHNjb3BlP1xuICAgIHZhciAkYWRkQW5vdGhlcnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1tb2R1bGU9XCJmaC1hZGQtYW5vdGhlclwiXScpO1xuXG5cdCRhZGRBbm90aGVycy5mb3JFYWNoKGZ1bmN0aW9uICgkYWRkQW5vdGhlcikge1xuXHRcdG5ldyB3aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIoJGFkZEFub3RoZXIpO1xuICAgIH0pO1xufVxuXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIgPSBmdW5jdGlvbiAoY29udGFpbmVyKSB7XG5cdHRoaXMuY29udGFpbmVyID0gJChjb250YWluZXIpO1xuXHR0aGlzLmluZGV4ID0gMDtcblxuXHRpZiAodGhpcy5jb250YWluZXIuZGF0YSgnZmgtYWRkLWFub3RoZXItaW5pdGlhbGlzZWQnKSkge1xuXHRcdHJldHVyblxuXHR9XG5cblx0Ly90b2RvOiB0aGlzIGlzIGEgYml0IGhhY2t5IC0gZmluZCBhIGJldHRlciB3YXkgdG8gZG8gdGhpc1xuXHR2YXIgZnVuY3Rpb25OYW1lID0gY29udGFpbmVyLmdldEF0dHJpYnV0ZSgnZGF0YS1maC1hZGQtYW5vdGhlci1jYWxsYmFjaycpO1xuXG5cdHRoaXMuY2FsbGJhY2sgPSBudWxsO1xuXHRkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24gKCkge1xuXHRcdGlmICh0eXBlb2Ygd2luZG93W2Z1bmN0aW9uTmFtZV0gPT09ICdmdW5jdGlvbicpIHtcblx0XHRcdHRoaXMuY2FsbGJhY2sgPSB3aW5kb3dbZnVuY3Rpb25OYW1lXTtcblx0XHRcdHRoaXMuY2FsbGJhY2soY29udGFpbmVyKTtcblx0XHR9XG5cdH0uYmluZCh0aGlzKSk7XG5cblx0dGhpcy5jb250YWluZXIuZGF0YSgnZmgtYWRkLWFub3RoZXItaW5pdGlhbGlzZWQnLCB0cnVlKTtcblxuXHR0aGlzLmNvbnRhaW5lci5vbignY2xpY2snLCAnLmZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uJywgJC5wcm94eSh0aGlzLCAnb25SZW1vdmVCdXR0b25DbGljaycpKTtcblx0dGhpcy5jb250YWluZXIub24oJ2NsaWNrJywgJy5maC1hZGQtYW5vdGhlcl9fYWRkLWJ1dHRvbicsICQucHJveHkodGhpcywgJ29uQWRkQnV0dG9uQ2xpY2snKSk7XG5cdHRoaXMuY29udGFpbmVyLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9fYWRkLWJ1dHRvbiwgZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nKS5wcm9wKCd0eXBlJywgJ3N1Ym1pdCcpO1xufTtcblxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5vbkFkZEJ1dHRvbkNsaWNrID0gZnVuY3Rpb24gKGUpIHtcblx0dmFyIGl0ZW0gPSB0aGlzLmdldE5ld0l0ZW0oKTtcblxuXHR2YXIgZmlyc3RJdGVtID0gdGhpcy5nZXRJdGVtcygpLmZpcnN0KCk7XG5cdGlmICghdGhpcy5oYXNSZW1vdmVCdXR0b24oZmlyc3RJdGVtKSkge1xuXHRcdHRoaXMuY3JlYXRlUmVtb3ZlQnV0dG9uKGZpcnN0SXRlbSk7XG5cdH1cblx0dGhpcy5nZXRJdGVtcygpLmxhc3QoKS5hZnRlcihpdGVtKTtcblx0aXRlbS5maW5kKCdpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCcpLmZpcnN0KCkuZm9jdXMoKTtcblx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xufTtcblxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5oYXNSZW1vdmVCdXR0b24gPSBmdW5jdGlvbiAoaXRlbSkge1xuXHRyZXR1cm4gaXRlbS5maW5kKCcuZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nKS5sZW5ndGg7XG59O1xuXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmdldEl0ZW1zID0gZnVuY3Rpb24gKCkge1xuXHRyZXR1cm4gdGhpcy5jb250YWluZXIuZmluZCgnLmZoLWFkZC1hbm90aGVyX19pdGVtJyk7XG59O1xuXG4vLyB0b2RvOiA/IGEgYmV0dGVyIGFwcHJvYWNoIHdvdWxkIGJlIHRvIGhhdmUgYSB0ZW1wbGF0ZSBpdGVtIHRoYXQgd2UgY2xvbmUsXG4vLyByYXRoZXIgdGhhbiBoYXZpbmcgdG8gc3RyaXAgdGhlIGVycm9yIGZyb20gdGhlIGZpcnN0IGl0ZW1cbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuc3RyaXBFcnJvckZyb21OZXdJdGVtID0gZnVuY3Rpb24gKGl0ZW06IEhUTUxFbGVtZW50KSB7XG5cblx0Ly8gcmVtb3ZlIHRoZSBnb3Z1ay1mb3JtLWdyb3VwLS1lcnJvciBjbGFzcyBmcm9tIGFueSBkaXZzIHRoYXQgaGF2ZSBpdCBzZXRcblx0aXRlbS5xdWVyeVNlbGVjdG9yQWxsKCdkaXYuZ292dWstZm9ybS1ncm91cC0tZXJyb3InKS5mb3JFYWNoKGZ1bmN0aW9uIChlbCwgaW5kZXgpIHtcblx0XHRlbC5jbGFzc0xpc3QucmVtb3ZlKCdnb3Z1ay1mb3JtLWdyb3VwLS1lcnJvcicpO1xuXHR9KTtcblxuXHQvLyBmaW5kIGFsbCBwYXJhZ3JhcGhzIHdpdGggdGhlIGNsYXNzIGdvdnVrLWVycm9yLW1lc3NhZ2UgYW5kIHJlbW92ZSB0aGVtXG5cdGl0ZW0ucXVlcnlTZWxlY3RvckFsbCgncC5nb3Z1ay1lcnJvci1tZXNzYWdlJykuZm9yRWFjaChmdW5jdGlvbiAoZWwsIGluZGV4KSB7XG4gICAgICAgIGVsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWwpO1xuXHR9KTtcblxuXHQvLyByZW1vdmUgdGhlIGdvdnVrLXNlbGVjdC0tZXJyb3IgY2xhc3MgZnJvbSBhbnkgc2VsZWN0cyB0aGF0IGhhdmUgaXQgc2V0XG5cdGl0ZW0ucXVlcnlTZWxlY3RvckFsbCgnc2VsZWN0LmdvdnVrLXNlbGVjdC0tZXJyb3InKS5mb3JFYWNoKGZ1bmN0aW9uIChlbCwgaW5kZXgpIHtcbiAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZSgnZ292dWstc2VsZWN0LS1lcnJvcicpO1xuXHR9KTtcblxuXHQvLyByZW1vdmUgdGhlIGdvdnVrLWlucHV0LS1lcnJvciBjbGFzcyBmcm9tIGFueSBpbnB1dHMgdGhhdCBoYXZlIGl0IHNldFxuXHRpdGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0LmdvdnVrLWlucHV0LS1lcnJvcicpLmZvckVhY2goZnVuY3Rpb24gKGVsLCBpbmRleCkge1xuXHRcdGVsLmNsYXNzTGlzdC5yZW1vdmUoJ2dvdnVrLWlucHV0LS1lcnJvcicpO1xuXHR9KTtcbn1cblxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5nZXROZXdJdGVtID0gZnVuY3Rpb24gKCkgeyAvLzogSlF1ZXJ5PEhUTUxFbGVtZW50PiAvL0hUTUxFbGVtZW50IHtcbiAgICAvLyBnZXQgdGhlIGZpcnN0IGl0ZW0gYW5kIGNsb25lIGl0XG4gICAgY29uc3QgaXRlbXMgPSB0aGlzLmdldEl0ZW1zKCk7XG4gICAgY29uc3QgaXRlbSA9IGl0ZW1zWzBdLmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MRWxlbWVudDtcblxuXHR0aGlzLnN0cmlwRXJyb3JGcm9tTmV3SXRlbShpdGVtKTtcblxuICAgIC8vIGZpbmQgdGhlIGF1dG9jb21wbGV0ZSB3cmFwcGVycyBhbmQgcmVtb3ZlIHRoZSBlbGVtZW50cyB0aGF0IGFyZSBhZGRlZCBieSBhY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZVxuICAgIGNvbnN0IGF1dG9jb21wbGV0ZVdyYXBwZXJzID0gaXRlbS5xdWVyeVNlbGVjdG9yQWxsKCcuYXV0b2NvbXBsZXRlX193cmFwcGVyJyk7XG4gICAgYXV0b2NvbXBsZXRlV3JhcHBlcnMuZm9yRWFjaCh3cmFwcGVyID0+IHtcbiAgICAgICAgaWYgKHdyYXBwZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlKSB7XG5cdFx0XHR3cmFwcGVyLnBhcmVudE5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh3cmFwcGVyLnBhcmVudE5vZGUpO1xuICAgICAgICB9XG4gICAgfSk7XG5cblx0dmFyICRpdGVtID0gJChpdGVtKTtcblxuXHQvLyB1cGRhdGUgdGhlIGlkIGFuZCBuYW1lIGF0dHJpYnV0ZXNcblx0dGhpcy51cGRhdGVBdHRyaWJ1dGVzKCsrdGhpcy5pbmRleCwgJGl0ZW0pO1xuXG5cdHRoaXMucmVzZXRJdGVtKCRpdGVtKTtcblxuXHQvLyBjYWxsIHRoZSBjYWxsYmFjayB3aGljaCBuZWVkcyB0byBhcHBseSBhY2Nlc3NpYmlsaXR5LWF1dG9jb21wbGV0ZSBlbmhhbmNlbWVudHMgdG8gdGhlIG5ldyBpdGVtXG5cdGlmICh0eXBlb2YgdGhpcy5jYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdHRoaXMuY2FsbGJhY2soaXRlbSk7XG5cdH1cblxuICAgIC8vIENyZWF0ZSBhIHJlbW92ZSBidXR0b24gaWYgaXQgZG9lc24ndCBleGlzdFxuICAgIGlmICghdGhpcy5oYXNSZW1vdmVCdXR0b24oJGl0ZW0pKSB7XG4gICAgICAgIHRoaXMuY3JlYXRlUmVtb3ZlQnV0dG9uKCRpdGVtKTtcbiAgICB9XG5cbiAgICByZXR1cm4gJGl0ZW07XG59O1xuXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLnVwZGF0ZUF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0pIHtcblx0aXRlbS5maW5kKCdbZGF0YS1uYW1lXScpLmVhY2goZnVuY3Rpb24gKGksIGVsKSB7XG5cdFx0dmFyIG9yaWdpbmFsSWQgPSBlbC5pZFxuXG5cdFx0ZWwubmFtZSA9ICQoZWwpLmF0dHIoJ2RhdGEtbmFtZScpLnJlcGxhY2UoLyVpbmRleCUvLCBpbmRleCk7XG5cdFx0ZWwuaWQgPSAkKGVsKS5hdHRyKCdkYXRhLWlkJykucmVwbGFjZSgvJWluZGV4JS8sIGluZGV4KTtcblxuXHRcdHZhciBsYWJlbCA9ICQoZWwpLnNpYmxpbmdzKCdsYWJlbCcpWzBdIHx8ICQoZWwpLnBhcmVudHMoJ2xhYmVsJylbMF0gfHwgaXRlbS5maW5kKCdbZm9yPVwiJyArIG9yaWdpbmFsSWQgKyAnXCJdJylbMF07XG5cdFx0bGFiZWwuaHRtbEZvciA9IGVsLmlkO1xuXHR9KTtcbn07XG5cbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuY3JlYXRlUmVtb3ZlQnV0dG9uID0gZnVuY3Rpb24gKGl0ZW0pIHtcblx0aXRlbS5hcHBlbmQoJzxidXR0b24gdHlwZT1cInN1Ym1pdFwiIGNsYXNzPVwiZ292dWstYnV0dG9uIGdvdnVrLWJ1dHRvbi0tc2Vjb25kYXJ5IGZoLWFkZC1hbm90aGVyX19yZW1vdmUtYnV0dG9uXCI+UmVtb3ZlPC9idXR0b24+Jyk7XG59O1xuXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLnJlc2V0SXRlbSA9IGZ1bmN0aW9uIChpdGVtKSB7XG5cdC8vIGFjY2Vzc2liaWxlLWF1dG9jb21wbGV0ZSBhZGRzIGFuIGlucHV0ICh3aXRob3V0IGRhdGEtbmFtZSBvciBkYXRhLWlkKVxuXHQvLyBzbyB3ZSBibGFuayBhbGwgaW5wdXQgY29udHJvbHNcbiAgICBpdGVtLmZpbmQoJ2lucHV0LCB0ZXh0YXJlYSwgc2VsZWN0JykuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsKSB7XG5cdFx0aWYgKGVsLnR5cGUgPT0gJ2NoZWNrYm94JyB8fCBlbC50eXBlID09ICdyYWRpbycpIHtcblx0XHRcdGVsLmNoZWNrZWQgPSBmYWxzZTtcblx0XHR9XG5cdFx0ZWxzZSB7XG4gICAgICAgICAgICBlbC52YWx1ZSA9ICcnO1xuICAgICAgICB9XG4gICAgfSk7XG59O1xuXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLm9uUmVtb3ZlQnV0dG9uQ2xpY2sgPSBmdW5jdGlvbiAoZSkge1xuXHQkKGUuY3VycmVudFRhcmdldCkucGFyZW50cygnLmZoLWFkZC1hbm90aGVyX19pdGVtJykucmVtb3ZlKCk7XG5cdHZhciBpdGVtcyA9IHRoaXMuZ2V0SXRlbXMoKTtcblx0aWYgKGl0ZW1zLmxlbmd0aCA9PT0gMSkge1xuXHRcdGl0ZW1zLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9fcmVtb3ZlLWJ1dHRvbicpLnJlbW92ZSgpO1xuXHR9XG5cdHRoaXMuZm9jdXNIZWFkaW5nKCk7XG5cdGUucHJldmVudERlZmF1bHQoKTtcbn07XG5cbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuZm9jdXNIZWFkaW5nID0gZnVuY3Rpb24gKCkge1xuXHR0aGlzLmNvbnRhaW5lci5maW5kKCcuZmgtYWRkLWFub3RoZXJfX2hlYWRpbmcnKS5mb2N1cygpO1xufTtcbiJdfQ==
