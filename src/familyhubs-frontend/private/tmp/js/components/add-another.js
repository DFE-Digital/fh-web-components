// A version of the MOJ's add-another component what plays nice with the accessible autocomplete component.
// I did consider subclassing the MOJ's add-another component,
// but it would have been so coupled that it would've probably broken on an update of the MOJ library.
// So instead we forked it and made our own version.
window.FamilyHubsFrontend = window.FamilyHubsFrontend || {};
export function initializeAddAnother() {
    //todo: support options with scope?
    var $addAnothers = document.querySelectorAll('[data-module="fh-add-another"]');
    $addAnothers.forEach(function ($addAnother) {
        new window.FamilyHubsFrontend.AddAnother($addAnother);
    });
}
window.FamilyHubsFrontend.AddAnother = function (container) {
    this.container = $(container);
    this.callback = null;
    if (this.container.data('fh-add-another-initialised')) {
        return;
    }
    this.container.data('fh-add-another-initialised', true);
    this.container.on('click', '.fh-add-another__remove-button', $.proxy(this, 'onRemoveButtonClick'));
    this.container.on('click', '.fh-add-another__add-button', $.proxy(this, 'onAddButtonClick'));
    this.container.find('.fh-add-another__add-button, fh-add-another__remove-button').prop('type', 'button');
};
window.FamilyHubsFrontend.AddAnother.prototype.setCallback = function (callback) {
    this.callback = callback;
};
window.FamilyHubsFrontend.AddAnother.prototype.onAddButtonClick = function (e) {
    var item = this.getNewItem();
    this.updateAttributes(this.getItems().length, item);
    this.resetItem(item);
    var firstItem = this.getItems().first();
    if (!this.hasRemoveButton(firstItem)) {
        this.createRemoveButton(firstItem);
    }
    this.getItems().last().after(item);
    item.find('input, textarea, select').first().focus();
};
window.FamilyHubsFrontend.AddAnother.prototype.hasRemoveButton = function (item) {
    return item.find('.fh-add-another__remove-button').length;
};
window.FamilyHubsFrontend.AddAnother.prototype.getItems = function () {
    return this.container.find('.fh-add-another__item');
};
window.FamilyHubsFrontend.AddAnother.prototype.getNewItem = function () {
    // Get the first item and clone it
    const items = this.getItems();
    const item = items[0].cloneNode(true);
    // Find the autocomplete wrappers and remove their parent
    const autocompleteWrappers = item.querySelectorAll('.autocomplete__wrapper');
    autocompleteWrappers.forEach(wrapper => {
        if (wrapper.parentNode.parentNode) {
            wrapper.parentNode.parentNode.removeChild(wrapper.parentNode);
        }
    });
    //todo: need to handle name and id before enhancing the select elements
    if (typeof this.callback === 'function') {
        this.callback(item);
    }
    // Enhance the select elements
    const languageSelects = item.querySelectorAll("[id^='language-']");
    languageSelects.forEach(select => {
        accessibleAutocomplete.enhanceSelectElement({
            name: 'languageName',
            defaultValue: '',
            selectElement: select
        });
    });
    var $item = $(item);
    // Create a remove button if it doesn't exist
    if (!this.hasRemoveButton($item)) {
        this.createRemoveButton($item);
    }
    return $item;
};
/*
//window.FamilyHubsFrontend.AddAnother.prototype.getNewItem = function () {
//	//todo: before cloning, try finding the div with class autocomplete__wrapper, then removing it's parent
//	// then clone, then call the select enhance on the new select
//	// will need a way to pass a function in to do this//

//	var item = this.getItems().first().clone();
//	if (!this.hasRemoveButton(item)) {
//		this.createRemoveButton(item);
//	}
    //	return item;

    var item = this.getItems().first().clone();

    //const autocompleteWrappers = item.find('.autocomplete__wrapper');
    //var autocompleteWrappers = document.querySelectorAll('.autocomplete__wrapper');

 //       //if (autocompleteWrappers.length) {
 //           autocompleteWrappers.forEach(function(wrapper) {
 //               wrapper.parentNode.remove();
 //           });
 //       //}
 //       //}

    const autocompleteWrappers = item.find('.autocomplete__wrapper');
    if (autocompleteWrappers.length) {
        autocompleteWrappers.each(function () {
            $(this).parent().remove();
        });
    }

    //todo: just poc!
    const languageSelects = item[0].querySelectorAll("[id^='language-']") as NodeListOf<HTMLSelectElement>; // [id$='\\d+']");

    languageSelects.forEach(function (select) {
        accessibleAutocomplete.enhanceSelectElement({
            //defaultValue: select.value,
            //todo: does it default to name in html?
            //name: select.name,
            name: 'languageName',
            defaultValue: '',
            selectElement: select
        })
    });


    if (!this.hasRemoveButton(item)) {
        this.createRemoveButton(item);
    }
    return item;
};
*/
window.FamilyHubsFrontend.AddAnother.prototype.updateAttributes = function (index, item) {
    item.find('[data-name]').each(function (i, el) {
        var originalId = el.id;
        el.name = $(el).attr('data-name').replace(/%index%/, index);
        el.id = $(el).attr('data-id').replace(/%index%/, index);
        var label = $(el).siblings('label')[0] || $(el).parents('label')[0] || item.find('[for="' + originalId + '"]')[0];
        label.htmlFor = el.id;
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.createRemoveButton = function (item) {
    item.append('<button type="button" class="govuk-button govuk-button--secondary fh-add-another__remove-button">Remove</button>');
};
window.FamilyHubsFrontend.AddAnother.prototype.resetItem = function (item) {
    // accessibile-autocomplete adds an input (without data-name or data-id)
    // so we blank all input controls
    item.find('input, textarea, select').each(function (index, el) {
        if (el.type == 'checkbox' || el.type == 'radio') {
            el.checked = false;
        }
        else {
            el.value = '';
        }
    });
};
window.FamilyHubsFrontend.AddAnother.prototype.onRemoveButtonClick = function (e) {
    $(e.currentTarget).parents('.fh-add-another__item').remove();
    var items = this.getItems();
    if (items.length === 1) {
        items.find('.fh-add-another__remove-button').remove();
    }
    items.each($.proxy(function (index, el) {
        this.updateAttributes(index, $(el));
    }, this));
    this.focusHeading();
};
window.FamilyHubsFrontend.AddAnother.prototype.focusHeading = function () {
    this.container.find('.fh-add-another__heading').focus();
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvYWRkLWFub3RoZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsMkdBQTJHO0FBQzNHLDhEQUE4RDtBQUM5RCxzR0FBc0c7QUFDdEcsb0RBQW9EO0FBa0JwRCxNQUFNLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxDQUFDLGtCQUFrQixJQUFJLEVBQUUsQ0FBQztBQUU1RCxNQUFNLFVBQVUsb0JBQW9CO0lBQ2hDLG1DQUFtQztJQUNuQyxJQUFJLFlBQVksR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztJQUUvRSxZQUFZLENBQUMsT0FBTyxDQUFDLFVBQVUsV0FBVztRQUM1QyxJQUFJLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDcEQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsR0FBRyxVQUFVLFNBQVM7SUFDekQsSUFBSSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7SUFFOUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFFckIsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxFQUFFLENBQUM7UUFDdkQsT0FBTTtJQUNQLENBQUM7SUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUV4RCxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxDQUFDO0lBQ25HLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxrQkFBa0IsQ0FBQyxD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QUFDLEVBQUUsQ0FBQztRQUN4QixLQUFLLENBQUMsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDdkQsQ0FBQztJQUNELEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLEtBQUssRUFBRSxFQUFFO1FBQ3JDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDckMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDVixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7QUFDckIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsWUFBWSxHQUFHO0lBQzdELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDekQsQ0FBQyxDQUFDIiwiZmlsZSI6ImNvbXBvbmVudHMvYWRkLWFub3RoZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBIHZlcnNpb24gb2YgdGhlIE1PSidzIGFkZC1hbm90aGVyIGNvbXBvbmVudCB3aGF0IHBsYXlzIG5pY2Ugd2l0aCB0aGUgYWNjZXNzaWJsZSBhdXRvY29tcGxldGUgY29tcG9uZW50LlxyXG4vLyBJIGRpZCBjb25zaWRlciBzdWJjbGFzc2luZyB0aGUgTU9KJ3MgYWRkLWFub3RoZXIgY29tcG9uZW50LFxyXG4vLyBidXQgaXQgd291bGQgaGF2ZSBiZWVuIHNvIGNvdXBsZWQgdGhhdCBpdCB3b3VsZCd2ZSBwcm9iYWJseSBicm9rZW4gb24gYW4gdXBkYXRlIG9mIHRoZSBNT0ogbGlicmFyeS5cclxuLy8gU28gaW5zdGVhZCB3ZSBmb3JrZWQgaXQgYW5kIG1hZGUgb3VyIG93biB2ZXJzaW9uLlxyXG5cclxuLy90b2RvOiB0aGUgY3JlYXRlZCBhY2Nlc3NpYmxlICBpbnB1dCB3aGVuIGFkZGluZyBkb2Vzbid0IGhhdmUgdGhlIGlkL25hbWUgZGF0YSBhdHRycywgc28gd2UgZ2V0IGR1cGUgaWRzXHJcbi8vdG9kbzogdGhlcmUgc2VlbXMgdG8gYmUgYSBidWcgaW4gYWNjZXNzaWJsZS1hdXRvY29tcGxldGUgd2hlcmUgdGhlIGlucHV0IGl0IGNyZWF0ZXMgaGFzIHRoZSBzYW1lIGlkIGFzIHRoZSBzZWxlY3RcclxuLy90b2RvOiB3ZSBuZWVkIHRvIGluaXRpYWxpc2UgdGhlIGFjY2Vzc2libGUgYXV0b2NvbXBsZXRlIG9uIHRoZSBuZXcgaXRlbVxyXG4vL3RvZG86IHdoZW4gZW5oYW5jaW5nIHRoZSBzZWxlY3QgaW4gYWNjZXNzaWJsZS1hdXRvY29tcGxldGUsIGl0IHJldHVybnMgdGhlIG5hbWUgcmF0aGVyIHRoYW4gdGhlIHZhbHVlXHJcbi8vIHRoZXJlJ3MgYSB3b3JrYXJvdW5kLi4uXHJcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbHBoYWdvdi9hY2Nlc3NpYmxlLWF1dG9jb21wbGV0ZS9pc3N1ZXMvMzg3XHJcbi8vIGJ1dCB3ZSBjb3VsZCB3ZSByb2xsIGl0IGludG8gb3VyIGFkZC1hbm90aGVyIGNvbXBvbmVudD9cclxuLy90b2RvOiB3aGVuIGFjY2Vzc2libGUtYXV0b2NvbXBsZXRlIGNyZWF0ZXMgdGhlIGlucHV0LCBpdCBkb2Vzbid0IGhhbmRsZSB0aGUgYXJpYS1kZXNjcmliZWRieSBjb3JyZWN0bHkuLi5cclxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2FscGhhZ292L2FjY2Vzc2libGUtYXV0b2NvbXBsZXRlL2lzc3Vlcy81ODlcclxuXHJcbi8vdG9kbzogdXNlIHRoZSBpbmRleC5kLnRzIGZyb20gaGVyZS4uLlxyXG4vLyBodHRwczovL2dpdGh1Yi5jb20vYWxwaGFnb3YvYWNjZXNzaWJsZS1hdXRvY29tcGxldGUvaXNzdWVzLzUzNVxyXG5kZWNsYXJlIGNvbnN0IGFjY2Vzc2libGVBdXRvY29tcGxldGU6IGFueTtcclxuXHJcbnR5cGUgQ2FsbGJhY2sgPSAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IHZvaWQ7XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kID0gd2luZG93LkZhbWlseUh1YnNGcm9udGVuZCB8fCB7fTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplQWRkQW5vdGhlcigpOiB2b2lkIHtcclxuICAgIC8vdG9kbzogc3VwcG9ydCBvcHRpb25zIHdpdGggc2NvcGU/XHJcbiAgICB2YXIgJGFkZEFub3RoZXJzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtbW9kdWxlPVwiZmgtYWRkLWFub3RoZXJcIl0nKTtcclxuXHJcbiAgICAkYWRkQW5vdGhlcnMuZm9yRWFjaChmdW5jdGlvbiAoJGFkZEFub3RoZXIpIHtcclxuXHRcdG5ldyB3aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIoJGFkZEFub3RoZXIpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlciA9IGZ1bmN0aW9uIChjb250YWluZXIpIHtcclxuXHR0aGlzLmNvbnRhaW5lciA9ICQoY29udGFpbmVyKTtcclxuXHJcblx0dGhpcy5jYWxsYmFjayA9IG51bGw7XHJcblxyXG5cdGlmICh0aGlzLmNvbnRhaW5lci5kYXRhKCdmaC1hZGQtYW5vdGhlci1pbml0aWFsaXNlZCcpKSB7XHJcblx0XHRyZXR1cm5cclxuXHR9XHJcblxyXG5cdHRoaXMuY29udGFpbmVyLmRhdGEoJ2ZoLWFkZC1hbm90aGVyLWluaXRpYWxpc2VkJywgdHJ1ZSk7XHJcblxyXG5cdHRoaXMuY29udGFpbmVyLm9uKCdjbGljaycsICcuZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nLCAkLnByb3h5KHRoaXMsICdvblJlbW92ZUJ1dHRvbkNsaWNrJykpO1xyXG5cdHRoaXMuY29udGFpbmVyLm9uKCdjbGljaycsICcuZmgtYWRkLWFub3RoZXJfX2FkZC1idXR0b24nLCAkLnByb3h5KHRoaXMsICdvbkFkZEJ1dHRvbkNsaWNrJykpO1xyXG5cdHRoaXMuY29udGFpbmVyLmZpbmQoJy5maC1hZGQtYW5vdGhlcl9fYWRkLWJ1dHRvbiwgZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nKS5wcm9wKCd0eXBlJywgJ2J1dHRvbicpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5zZXRDYWxsYmFjayA9IGZ1bmN0aW9uIChjYWxsYmFjazogQ2FsbGJhY2spIHtcclxuXHR0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLm9uQWRkQnV0dG9uQ2xpY2sgPSBmdW5jdGlvbiAoZSkge1xyXG5cdHZhciBpdGVtID0gdGhpcy5nZXROZXdJdGVtKCk7XHJcblx0dGhpcy51cGRhdGVBdHRyaWJ1dGVzKHRoaXMuZ2V0SXRlbXMoKS5sZW5ndGgsIGl0ZW0pO1xyXG5cdHRoaXMucmVzZXRJdGVtKGl0ZW0pO1xyXG5cdHZhciBmaXJzdEl0ZW0gPSB0aGlzLmdldEl0ZW1zKCkuZmlyc3QoKTtcclxuXHRpZiAoIXRoaXMuaGFzUmVtb3ZlQnV0dG9uKGZpcnN0SXRlbSkpIHtcclxuXHRcdHRoaXMuY3JlYXRlUmVtb3ZlQnV0dG9uKGZpcnN0SXRlbSk7XHJcblx0fVxyXG5cdHRoaXMuZ2V0SXRlbXMoKS5sYXN0KCkuYWZ0ZXIoaXRlbSk7XHJcblx0aXRlbS5maW5kKCdpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCcpLmZpcnN0KCkuZm9jdXMoKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuaGFzUmVtb3ZlQnV0dG9uID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuXHRyZXR1cm4gaXRlbS5maW5kKCcuZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nKS5sZW5ndGg7XHJcbn07XHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLmdldEl0ZW1zID0gZnVuY3Rpb24gKCkge1xyXG5cdHJldHVybiB0aGlzLmNvbnRhaW5lci5maW5kKCcuZmgtYWRkLWFub3RoZXJfX2l0ZW0nKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuZ2V0TmV3SXRlbSA9IGZ1bmN0aW9uICgpIHsgLy86IEpRdWVyeTxIVE1MRWxlbWVudD4gLy9IVE1MRWxlbWVudCB7XHJcbiAgICAvLyBHZXQgdGhlIGZpcnN0IGl0ZW0gYW5kIGNsb25lIGl0XHJcbiAgICBjb25zdCBpdGVtcyA9IHRoaXMuZ2V0SXRlbXMoKTtcclxuICAgIGNvbnN0IGl0ZW0gPSBpdGVtc1swXS5jbG9uZU5vZGUodHJ1ZSkgYXMgSFRNTEVsZW1lbnQ7XHJcblxyXG4gICAgLy8gRmluZCB0aGUgYXV0b2NvbXBsZXRlIHdyYXBwZXJzIGFuZCByZW1vdmUgdGhlaXIgcGFyZW50XHJcbiAgICBjb25zdCBhdXRvY29tcGxldGVXcmFwcGVycyA9IGl0ZW0ucXVlcnlTZWxlY3RvckFsbCgnLmF1dG9jb21wbGV0ZV9fd3JhcHBlcicpO1xyXG4gICAgYXV0b2NvbXBsZXRlV3JhcHBlcnMuZm9yRWFjaCh3cmFwcGVyID0+IHtcclxuICAgICAgICBpZiAod3JhcHBlci5wYXJlbnROb2RlLnBhcmVudE5vZGUpIHtcclxuXHRcdFx0d3JhcHBlci5wYXJlbnROb2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQod3JhcHBlci5wYXJlbnROb2RlKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcblx0Ly90b2RvOiBuZWVkIHRvIGhhbmRsZSBuYW1lIGFuZCBpZCBiZWZvcmUgZW5oYW5jaW5nIHRoZSBzZWxlY3QgZWxlbWVudHNcclxuXHJcblx0aWYgKHR5cGVvZiB0aGlzLmNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XHJcblx0XHR0aGlzLmNhbGxiYWNrKGl0ZW0pO1xyXG5cdH1cclxuXHJcbiAgICAvLyBFbmhhbmNlIHRoZSBzZWxlY3QgZWxlbWVudHNcclxuICAgIGNvbnN0IGxhbmd1YWdlU2VsZWN0cyA9IGl0ZW0ucXVlcnlTZWxlY3RvckFsbChcIltpZF49J2xhbmd1YWdlLSddXCIpIGFzIE5vZGVMaXN0T2Y8SFRNTFNlbGVjdEVsZW1lbnQ+O1xyXG4gICAgbGFuZ3VhZ2VTZWxlY3RzLmZvckVhY2goc2VsZWN0ID0+IHtcclxuICAgICAgICBhY2Nlc3NpYmxlQXV0b2NvbXBsZXRlLmVuaGFuY2VTZWxlY3RFbGVtZW50KHtcclxuICAgICAgICAgICAgbmFtZTogJ2xhbmd1YWdlTmFtZScsXHJcbiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogJycsXHJcbiAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQ6IHNlbGVjdFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdmFyICRpdGVtID0gJChpdGVtKTtcclxuXHJcbiAgICAvLyBDcmVhdGUgYSByZW1vdmUgYnV0dG9uIGlmIGl0IGRvZXNuJ3QgZXhpc3RcclxuICAgIGlmICghdGhpcy5oYXNSZW1vdmVCdXR0b24oJGl0ZW0pKSB7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVSZW1vdmVCdXR0b24oJGl0ZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiAkaXRlbTtcclxufTtcclxuXHJcbi8qXHJcbi8vd2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5nZXROZXdJdGVtID0gZnVuY3Rpb24gKCkge1xyXG4vL1x0Ly90b2RvOiBiZWZvcmUgY2xvbmluZywgdHJ5IGZpbmRpbmcgdGhlIGRpdiB3aXRoIGNsYXNzIGF1dG9jb21wbGV0ZV9fd3JhcHBlciwgdGhlbiByZW1vdmluZyBpdCdzIHBhcmVudFxyXG4vL1x0Ly8gdGhlbiBjbG9uZSwgdGhlbiBjYWxsIHRoZSBzZWxlY3QgZW5oYW5jZSBvbiB0aGUgbmV3IHNlbGVjdFxyXG4vL1x0Ly8gd2lsbCBuZWVkIGEgd2F5IHRvIHBhc3MgYSBmdW5jdGlvbiBpbiB0byBkbyB0aGlzLy9cclxuXHJcbi8vXHR2YXIgaXRlbSA9IHRoaXMuZ2V0SXRlbXMoKS5maXJzdCgpLmNsb25lKCk7XHJcbi8vXHRpZiAoIXRoaXMuaGFzUmVtb3ZlQnV0dG9uKGl0ZW0pKSB7XHJcbi8vXHRcdHRoaXMuY3JlYXRlUmVtb3ZlQnV0dG9uKGl0ZW0pO1xyXG4vL1x0fVxyXG5cdC8vXHRyZXR1cm4gaXRlbTtcclxuXHJcblx0dmFyIGl0ZW0gPSB0aGlzLmdldEl0ZW1zKCkuZmlyc3QoKS5jbG9uZSgpO1xyXG5cclxuXHQvL2NvbnN0IGF1dG9jb21wbGV0ZVdyYXBwZXJzID0gaXRlbS5maW5kKCcuYXV0b2NvbXBsZXRlX193cmFwcGVyJyk7XHJcblx0Ly92YXIgYXV0b2NvbXBsZXRlV3JhcHBlcnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuYXV0b2NvbXBsZXRlX193cmFwcGVyJyk7XHJcblxyXG4gLy8gICAgICAgLy9pZiAoYXV0b2NvbXBsZXRlV3JhcHBlcnMubGVuZ3RoKSB7XHJcbiAvLyAgICAgICAgICAgYXV0b2NvbXBsZXRlV3JhcHBlcnMuZm9yRWFjaChmdW5jdGlvbih3cmFwcGVyKSB7XHJcbiAvLyAgICAgICAgICAgICAgIHdyYXBwZXIucGFyZW50Tm9kZS5yZW1vdmUoKTtcclxuIC8vICAgICAgICAgICB9KTtcclxuIC8vICAgICAgIC8vfVxyXG4gLy8gICAgICAgLy99XHJcblxyXG5cdGNvbnN0IGF1dG9jb21wbGV0ZVdyYXBwZXJzID0gaXRlbS5maW5kKCcuYXV0b2NvbXBsZXRlX193cmFwcGVyJyk7XHJcblx0aWYgKGF1dG9jb21wbGV0ZVdyYXBwZXJzLmxlbmd0aCkge1xyXG5cdFx0YXV0b2NvbXBsZXRlV3JhcHBlcnMuZWFjaChmdW5jdGlvbiAoKSB7XHJcblx0XHRcdCQodGhpcykucGFyZW50KCkucmVtb3ZlKCk7XHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdC8vdG9kbzoganVzdCBwb2MhXHJcblx0Y29uc3QgbGFuZ3VhZ2VTZWxlY3RzID0gaXRlbVswXS5xdWVyeVNlbGVjdG9yQWxsKFwiW2lkXj0nbGFuZ3VhZ2UtJ11cIikgYXMgTm9kZUxpc3RPZjxIVE1MU2VsZWN0RWxlbWVudD47IC8vIFtpZCQ9J1xcXFxkKyddXCIpO1xyXG5cclxuIFx0bGFuZ3VhZ2VTZWxlY3RzLmZvckVhY2goZnVuY3Rpb24gKHNlbGVjdCkge1xyXG5cdFx0YWNjZXNzaWJsZUF1dG9jb21wbGV0ZS5lbmhhbmNlU2VsZWN0RWxlbWVudCh7XHJcblx0XHRcdC8vZGVmYXVsdFZhbHVlOiBzZWxlY3QudmFsdWUsXHJcblx0XHRcdC8vdG9kbzogZG9lcyBpdCBkZWZhdWx0IHRvIG5hbWUgaW4gaHRtbD9cclxuXHRcdFx0Ly9uYW1lOiBzZWxlY3QubmFtZSxcclxuXHRcdFx0bmFtZTogJ2xhbmd1YWdlTmFtZScsXHJcblx0XHRcdGRlZmF1bHRWYWx1ZTogJycsXHJcblx0XHRcdHNlbGVjdEVsZW1lbnQ6IHNlbGVjdFxyXG5cdFx0fSlcclxuXHR9KTtcclxuXHJcblxyXG4gICAgaWYgKCF0aGlzLmhhc1JlbW92ZUJ1dHRvbihpdGVtKSkge1xyXG4gICAgICAgIHRoaXMuY3JlYXRlUmVtb3ZlQnV0dG9uKGl0ZW0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGl0ZW07XHJcbn07XHJcbiovXHJcblxyXG53aW5kb3cuRmFtaWx5SHVic0Zyb250ZW5kLkFkZEFub3RoZXIucHJvdG90eXBlLnVwZGF0ZUF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0pIHtcclxuXHRpdGVtLmZpbmQoJ1tkYXRhLW5hbWVdJykuZWFjaChmdW5jdGlvbiAoaSwgZWwpIHtcclxuXHRcdHZhciBvcmlnaW5hbElkID0gZWwuaWRcclxuXHJcblx0XHRlbC5uYW1lID0gJChlbCkuYXR0cignZGF0YS1uYW1lJykucmVwbGFjZSgvJWluZGV4JS8sIGluZGV4KTtcclxuXHRcdGVsLmlkID0gJChlbCkuYXR0cignZGF0YS1pZCcpLnJlcGxhY2UoLyVpbmRleCUvLCBpbmRleCk7XHJcblxyXG5cdFx0dmFyIGxhYmVsID0gJChlbCkuc2libGluZ3MoJ2xhYmVsJylbMF0gfHwgJChlbCkucGFyZW50cygnbGFiZWwnKVswXSB8fCBpdGVtLmZpbmQoJ1tmb3I9XCInICsgb3JpZ2luYWxJZCArICdcIl0nKVswXTtcclxuXHRcdGxhYmVsLmh0bWxGb3IgPSBlbC5pZDtcclxuXHR9KTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUuY3JlYXRlUmVtb3ZlQnV0dG9uID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuXHRpdGVtLmFwcGVuZCgnPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgY2xhc3M9XCJnb3Z1ay1idXR0b24gZ292dWstYnV0dG9uLS1zZWNvbmRhcnkgZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b25cIj5SZW1vdmU8L2J1dHRvbj4nKTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUucmVzZXRJdGVtID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuXHQvLyBhY2Nlc3NpYmlsZS1hdXRvY29tcGxldGUgYWRkcyBhbiBpbnB1dCAod2l0aG91dCBkYXRhLW5hbWUgb3IgZGF0YS1pZClcclxuXHQvLyBzbyB3ZSBibGFuayBhbGwgaW5wdXQgY29udHJvbHNcclxuICAgIGl0ZW0uZmluZCgnaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QnKS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWwpIHtcclxuICAgICAgICBpZiAoZWwudHlwZSA9PSAnY2hlY2tib3gnIHx8IGVsLnR5cGUgPT0gJ3JhZGlvJykge1xyXG4gICAgICAgICAgICBlbC5jaGVja2VkID0gZmFsc2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZWwudmFsdWUgPSAnJztcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufTtcclxuXHJcbndpbmRvdy5GYW1pbHlIdWJzRnJvbnRlbmQuQWRkQW5vdGhlci5wcm90b3R5cGUub25SZW1vdmVCdXR0b25DbGljayA9IGZ1bmN0aW9uIChlKSB7XHJcblx0JChlLmN1cnJlbnRUYXJnZXQpLnBhcmVudHMoJy5maC1hZGQtYW5vdGhlcl9faXRlbScpLnJlbW92ZSgpO1xyXG5cdHZhciBpdGVtcyA9IHRoaXMuZ2V0SXRlbXMoKTtcclxuXHRpZiAoaXRlbXMubGVuZ3RoID09PSAxKSB7XHJcblx0XHRpdGVtcy5maW5kKCcuZmgtYWRkLWFub3RoZXJfX3JlbW92ZS1idXR0b24nKS5yZW1vdmUoKTtcclxuXHR9XHJcblx0aXRlbXMuZWFjaCgkLnByb3h5KGZ1bmN0aW9uIChpbmRleCwgZWwpIHtcclxuXHRcdHRoaXMudXBkYXRlQXR0cmlidXRlcyhpbmRleCwgJChlbCkpO1xyXG5cdH0sIHRoaXMpKTtcclxuXHR0aGlzLmZvY3VzSGVhZGluZygpO1xyXG59O1xyXG5cclxud2luZG93LkZhbWlseUh1YnNGcm9udGVuZC5BZGRBbm90aGVyLnByb3RvdHlwZS5mb2N1c0hlYWRpbmcgPSBmdW5jdGlvbiAoKSB7XHJcblx0dGhpcy5jb250YWluZXIuZmluZCgnLmZoLWFkZC1hbm90aGVyX19oZWFkaW5nJykuZm9jdXMoKTtcclxufTtcclxuIl19
